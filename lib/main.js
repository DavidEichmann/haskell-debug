"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
Object.defineProperty(exports, "__esModule", { value: true });
const Debugger = require("./Debugger");
const BreakpointUI = require("./BreakpointUI");
const TooltipOverride = require("./TooltipOverride");
const atomAPI = require("atom");
const os = require("os");
const path = require("path");
const cp = require("child_process");
const config_1 = require("./config");
var config_2 = require("./config");
exports.config = config_2.config;
const breakpointUI = new BreakpointUI();
let debuggerInst;
let upi;
let state;
let disposables;
const commands = {
    'debug': ({ currentTarget }) => __awaiter(this, void 0, void 0, function* () {
        const ob = upi && (yield upi.getOthersConfigParam('ide-haskell-cabal', 'builder'));
        if (ob) {
            debuggerInst = new Debugger(breakpointUI.breakpoints, currentTarget.getModel(), ob.name);
        }
        else {
            debuggerInst = new Debugger(breakpointUI.breakpoints, currentTarget.getModel());
        }
    }),
    'debug-back': () => {
        if (debuggerInst) {
            debuggerInst.back();
        }
    },
    'debug-forward': () => {
        if (debuggerInst) {
            debuggerInst.forward();
        }
    },
    'debug-step': () => {
        if (debuggerInst) {
            debuggerInst.step();
        }
    },
    'debug-stop': () => {
        if (debuggerInst) {
            debuggerInst.stop();
        }
    },
    'debug-continue': () => {
        if (debuggerInst) {
            debuggerInst.continue();
        }
    },
    'toggle-breakpoint': ({ currentTarget }) => {
        breakpointUI.toggleBreakpoint(currentTarget.getModel().getCursorBufferPosition().row + 1, currentTarget.getModel());
    },
    'set-break-on-exception': () => __awaiter(this, void 0, void 0, function* () {
        const selectDebugModeView = require('./views/SelectDebugModeView');
        const result = yield selectDebugModeView(config_1.debugModes, atom.config.get('haskell-debug.breakOnException'));
        if (result !== undefined) {
            atom.config.set('haskell-debug.breakOnException', result);
        }
    })
};
function onFirstRun() {
    state = {
        properlyActivated: false
    };
    const isWin = os.platform().indexOf('win') > -1;
    const where = isWin ? 'where' : 'whereis';
    const out = cp.exec(where + ' node');
    out.on('close', (code) => {
        if (code === 1) {
            atom.config.set('haskell-debug.nodeCommand', path.resolve(atom.packages.getApmPath(), '../../bin/atom'));
            if (state) {
                state.properlyActivated = true;
            }
        }
    });
}
function activePaneObserver(pane) {
    if (atom.workspace.isTextEditor(pane)) {
        const te = pane;
        const scopes = te.getRootScopeDescriptor().getScopesArray();
        if (scopes.length === 1 && scopes[0] === 'source.haskell') {
            if (!te.hasHaskellBreakpoints) {
                breakpointUI.attachToNewTextEditor(te);
                te.hasHaskellBreakpoints = true;
            }
            if (debuggerInst) {
                debuggerInst.showPanels();
            }
            return;
        }
    }
    if (debuggerInst) {
        debuggerInst.hidePanels();
    }
}
function activate(_state) {
    disposables = new atomAPI.CompositeDisposable();
    state = _state;
    if (state === undefined || state.properlyActivated !== true) {
        onFirstRun();
    }
    disposables.add(atom.workspace.observeActivePaneItem(activePaneObserver));
    for (const command of Object.keys(commands)) {
        disposables.add(atom.commands.add("atom-text-editor[data-grammar='source haskell']", 'haskell:' + command, commands[command]));
    }
}
exports.activate = activate;
function deactivate() {
    disposables && disposables.dispose();
}
exports.deactivate = deactivate;
function serialize() {
    return state;
}
exports.serialize = serialize;
function consumeHaskellUpi(reg) {
    const tooltipOverride = new TooltipOverride((expression) => __awaiter(this, void 0, void 0, function* () {
        if (debuggerInst === undefined) {
            return;
        }
        return debuggerInst.resolveExpression(expression);
    }));
    upi = reg({
        name: 'haskell-debug',
        tooltip: {
            priority: 100,
            handler: tooltipOverride.tooltipHandler.bind(tooltipOverride)
        }
    });
    return upi;
}
exports.consumeHaskellUpi = consumeHaskellUpi;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9saWIvbWFpbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsdUNBQXVDO0FBQ3ZDLCtDQUErQztBQUMvQyxxREFBcUQ7QUFDckQsZ0NBQWdDO0FBQ2hDLHlCQUF5QjtBQUN6Qiw2QkFBNkI7QUFDN0Isb0NBQW9DO0FBQ3BDLHFDQUFtQztBQUNuQyxtQ0FBK0I7QUFBdkIsMEJBQUEsTUFBTSxDQUFBO0FBRWQsTUFBTSxZQUFZLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQTtBQUV2QyxJQUFJLFlBQWtDLENBQUE7QUFDdEMsSUFBSSxHQUFpQyxDQUFBO0FBQ3JDLElBQUksS0FBb0MsQ0FBQTtBQUN4QyxJQUFJLFdBQW9ELENBQUE7QUFFeEQsTUFBTSxRQUFRLEdBQUc7SUFDYixPQUFPLEVBQUUsQ0FBTyxFQUFDLGFBQWEsRUFBcUI7UUFDL0MsTUFBTSxFQUFFLEdBQUcsR0FBRyxLQUFJLE1BQU0sR0FBRyxDQUFDLG9CQUFvQixDQUFpQixtQkFBbUIsRUFBRSxTQUFTLENBQUMsQ0FBQSxDQUFBO1FBQ2hHLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDUCxZQUFZLEdBQUcsSUFBSSxRQUFRLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxhQUFhLENBQUMsUUFBUSxFQUFFLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFBO1FBQzFGLENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLFlBQVksR0FBRyxJQUFJLFFBQVEsQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLGFBQWEsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFBO1FBQ2pGLENBQUM7SUFDTCxDQUFDLENBQUE7SUFDRCxZQUFZLEVBQUU7UUFDVixFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1lBQ2YsWUFBWSxDQUFDLElBQUksRUFBRSxDQUFBO1FBQ3ZCLENBQUM7SUFDTCxDQUFDO0lBQ0QsZUFBZSxFQUFFO1FBQ2IsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztZQUNmLFlBQVksQ0FBQyxPQUFPLEVBQUUsQ0FBQTtRQUMxQixDQUFDO0lBQ0wsQ0FBQztJQUNELFlBQVksRUFBRTtRQUNWLEVBQUUsQ0FBQyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7WUFDZixZQUFZLENBQUMsSUFBSSxFQUFFLENBQUE7UUFDdkIsQ0FBQztJQUNMLENBQUM7SUFDRCxZQUFZLEVBQUU7UUFDVixFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1lBQ2YsWUFBWSxDQUFDLElBQUksRUFBRSxDQUFBO1FBQ3ZCLENBQUM7SUFDTCxDQUFDO0lBQ0QsZ0JBQWdCLEVBQUU7UUFDZCxFQUFFLENBQUMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO1lBQ2YsWUFBWSxDQUFDLFFBQVEsRUFBRSxDQUFBO1FBQzNCLENBQUM7SUFDTCxDQUFDO0lBQ0QsbUJBQW1CLEVBQUUsQ0FBQyxFQUFDLGFBQWEsRUFBcUI7UUFDckQsWUFBWSxDQUFDLGdCQUFnQixDQUN6QixhQUFhLENBQUMsUUFBUSxFQUFFLENBQUMsdUJBQXVCLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxFQUMxRCxhQUFhLENBQUMsUUFBUSxFQUFFLENBQzNCLENBQUE7SUFDTCxDQUFDO0lBQ0Qsd0JBQXdCLEVBQUU7UUFDdEIsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsNkJBQTZCLENBQUMsQ0FBQTtRQUNsRSxNQUFNLE1BQU0sR0FBRyxNQUFNLG1CQUFtQixDQUFDLG1CQUFVLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsZ0NBQWdDLENBQUMsQ0FBQyxDQUFBO1FBQ3ZHLEVBQUUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsZ0NBQWdDLEVBQUUsTUFBTSxDQUFDLENBQUE7UUFBQyxDQUFDO0lBQzNGLENBQUMsQ0FBQTtDQUNKLENBQUE7QUFFRDtJQUNJLEtBQUssR0FBRztRQUNKLGlCQUFpQixFQUFFLEtBQUs7S0FDM0IsQ0FBQTtJQUdELE1BQU0sS0FBSyxHQUFHLEVBQUUsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUE7SUFDL0MsTUFBTSxLQUFLLEdBQUcsS0FBSyxHQUFHLE9BQU8sR0FBRyxTQUFTLENBQUE7SUFFekMsTUFBTSxHQUFHLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLENBQUE7SUFFcEMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxJQUFJO1FBQ2pCLEVBQUUsQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRWIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsMkJBQTJCLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsRUFBRSxFQUFFLGdCQUFnQixDQUFDLENBQUMsQ0FBQTtZQUN4RyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUFDLEtBQUssQ0FBQyxpQkFBaUIsR0FBRyxJQUFJLENBQUE7WUFBQyxDQUFDO1FBQ2pELENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQTtBQUNOLENBQUM7QUFFRCw0QkFBNkIsSUFBa0I7SUFDM0MsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3BDLE1BQU0sRUFBRSxHQUE2RCxJQUFJLENBQUE7UUFDekUsTUFBTSxNQUFNLEdBQUcsRUFBRSxDQUFDLHNCQUFzQixFQUFFLENBQUMsY0FBYyxFQUFFLENBQUE7UUFDM0QsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLGdCQUFnQixDQUFDLENBQUMsQ0FBQztZQUN4RCxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDLENBQUM7Z0JBQzVCLFlBQVksQ0FBQyxxQkFBcUIsQ0FBQyxFQUFFLENBQUMsQ0FBQTtnQkFDdEMsRUFBRSxDQUFDLHFCQUFxQixHQUFHLElBQUksQ0FBQTtZQUNuQyxDQUFDO1lBQ0QsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztnQkFDZixZQUFZLENBQUMsVUFBVSxFQUFFLENBQUE7WUFDN0IsQ0FBQztZQUNELE1BQU0sQ0FBQTtRQUNWLENBQUM7SUFDTCxDQUFDO0lBRUQsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztRQUNmLFlBQVksQ0FBQyxVQUFVLEVBQUUsQ0FBQTtJQUM3QixDQUFDO0FBQ0wsQ0FBQztBQU1ELGtCQUEwQixNQUEwQjtJQUNoRCxXQUFXLEdBQUcsSUFBSSxPQUFPLENBQUMsbUJBQW1CLEVBQUUsQ0FBQTtJQUMvQyxLQUFLLEdBQUcsTUFBTSxDQUFBO0lBRWQsRUFBRSxDQUFDLENBQUMsS0FBSyxLQUFLLFNBQVMsSUFBSSxLQUFLLENBQUMsaUJBQWlCLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQztRQUMxRCxVQUFVLEVBQUUsQ0FBQTtJQUNoQixDQUFDO0lBQ0QsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLHFCQUFxQixDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQTtJQUV6RSxHQUFHLENBQUMsQ0FBQyxNQUFNLE9BQU8sSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM1QyxXQUFXLENBQUMsR0FBRyxDQUNiLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGlEQUFpRCxFQUNqRCxVQUFVLEdBQUcsT0FBTyxFQUNwQixRQUFRLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FDckMsQ0FBQTtJQUNILENBQUM7QUFDTCxDQUFDO0FBaEJELDRCQWdCQztBQUVEO0lBQ0ksV0FBVyxJQUFJLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQTtBQUN4QyxDQUFDO0FBRkQsZ0NBRUM7QUFFRDtJQUNJLE1BQU0sQ0FBQyxLQUFLLENBQUE7QUFDaEIsQ0FBQztBQUZELDhCQUVDO0FBRUQsMkJBQW1DLEdBQXlCO0lBQ3hELE1BQU0sZUFBZSxHQUFHLElBQUksZUFBZSxDQUFDLENBQU8sVUFBVTtRQUN6RCxFQUFFLENBQUMsQ0FBQyxZQUFZLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUFDLE1BQU0sQ0FBQTtRQUFDLENBQUM7UUFDMUMsTUFBTSxDQUFDLFlBQVksQ0FBQyxpQkFBaUIsQ0FBQyxVQUFVLENBQUMsQ0FBQTtJQUNyRCxDQUFDLENBQUEsQ0FBQyxDQUFBO0lBQ0YsR0FBRyxHQUFHLEdBQUcsQ0FBQztRQUNSLElBQUksRUFBRSxlQUFlO1FBQ3JCLE9BQU8sRUFBRTtZQUNQLFFBQVEsRUFBRSxHQUFHO1lBQ2IsT0FBTyxFQUFFLGVBQWUsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQztTQUM5RDtLQUNGLENBQUMsQ0FBQTtJQUNGLE1BQU0sQ0FBQyxHQUFHLENBQUE7QUFDZCxDQUFDO0FBYkQsOENBYUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgRGVidWdnZXIgPSByZXF1aXJlKCcuL0RlYnVnZ2VyJylcbmltcG9ydCBCcmVha3BvaW50VUkgPSByZXF1aXJlKCcuL0JyZWFrcG9pbnRVSScpXG5pbXBvcnQgVG9vbHRpcE92ZXJyaWRlID0gcmVxdWlyZSgnLi9Ub29sdGlwT3ZlcnJpZGUnKVxuaW1wb3J0IGF0b21BUEkgPSByZXF1aXJlKCdhdG9tJylcbmltcG9ydCBvcyA9IHJlcXVpcmUoJ29zJylcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpXG5pbXBvcnQgY3AgPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJylcbmltcG9ydCB7ZGVidWdNb2Rlc30gZnJvbSAnLi9jb25maWcnXG5leHBvcnQge2NvbmZpZ30gZnJvbSAnLi9jb25maWcnXG5cbmNvbnN0IGJyZWFrcG9pbnRVSSA9IG5ldyBCcmVha3BvaW50VUkoKVxuXG5sZXQgZGVidWdnZXJJbnN0OiBEZWJ1Z2dlciB8IHVuZGVmaW5lZFxubGV0IHVwaTogVVBJLklVUElJbnN0YW5jZSB8IHVuZGVmaW5lZFxubGV0IHN0YXRlOiBIYXNrZWxsRGVidWdTdGF0ZSB8IHVuZGVmaW5lZFxubGV0IGRpc3Bvc2FibGVzOiBhdG9tQVBJLkNvbXBvc2l0ZURpc3Bvc2FibGUgfCB1bmRlZmluZWRcblxuY29uc3QgY29tbWFuZHMgPSB7XG4gICAgJ2RlYnVnJzogYXN5bmMgKHtjdXJyZW50VGFyZ2V0fTogYXRvbUFQSS5JRXZlbnREZXNjKSA9PiB7XG4gICAgICAgIGNvbnN0IG9iID0gdXBpICYmIGF3YWl0IHVwaS5nZXRPdGhlcnNDb25maWdQYXJhbTx7bmFtZTogc3RyaW5nfT4oJ2lkZS1oYXNrZWxsLWNhYmFsJywgJ2J1aWxkZXInKVxuICAgICAgICBpZiAob2IpIHtcbiAgICAgICAgICBkZWJ1Z2dlckluc3QgPSBuZXcgRGVidWdnZXIoYnJlYWtwb2ludFVJLmJyZWFrcG9pbnRzLCBjdXJyZW50VGFyZ2V0LmdldE1vZGVsKCksIG9iLm5hbWUpXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZGVidWdnZXJJbnN0ID0gbmV3IERlYnVnZ2VyKGJyZWFrcG9pbnRVSS5icmVha3BvaW50cywgY3VycmVudFRhcmdldC5nZXRNb2RlbCgpKVxuICAgICAgICB9XG4gICAgfSxcbiAgICAnZGVidWctYmFjayc6ICgpID0+IHtcbiAgICAgICAgaWYgKGRlYnVnZ2VySW5zdCkge1xuICAgICAgICAgICAgZGVidWdnZXJJbnN0LmJhY2soKVxuICAgICAgICB9XG4gICAgfSxcbiAgICAnZGVidWctZm9yd2FyZCc6ICgpID0+IHtcbiAgICAgICAgaWYgKGRlYnVnZ2VySW5zdCkge1xuICAgICAgICAgICAgZGVidWdnZXJJbnN0LmZvcndhcmQoKVxuICAgICAgICB9XG4gICAgfSxcbiAgICAnZGVidWctc3RlcCc6ICgpID0+IHtcbiAgICAgICAgaWYgKGRlYnVnZ2VySW5zdCkge1xuICAgICAgICAgICAgZGVidWdnZXJJbnN0LnN0ZXAoKVxuICAgICAgICB9XG4gICAgfSxcbiAgICAnZGVidWctc3RvcCc6ICgpID0+IHtcbiAgICAgICAgaWYgKGRlYnVnZ2VySW5zdCkge1xuICAgICAgICAgICAgZGVidWdnZXJJbnN0LnN0b3AoKVxuICAgICAgICB9XG4gICAgfSxcbiAgICAnZGVidWctY29udGludWUnOiAoKSA9PiB7XG4gICAgICAgIGlmIChkZWJ1Z2dlckluc3QpIHtcbiAgICAgICAgICAgIGRlYnVnZ2VySW5zdC5jb250aW51ZSgpXG4gICAgICAgIH1cbiAgICB9LFxuICAgICd0b2dnbGUtYnJlYWtwb2ludCc6ICh7Y3VycmVudFRhcmdldH06IGF0b21BUEkuSUV2ZW50RGVzYykgPT4ge1xuICAgICAgICBicmVha3BvaW50VUkudG9nZ2xlQnJlYWtwb2ludChcbiAgICAgICAgICAgIGN1cnJlbnRUYXJnZXQuZ2V0TW9kZWwoKS5nZXRDdXJzb3JCdWZmZXJQb3NpdGlvbigpLnJvdyArIDEsXG4gICAgICAgICAgICBjdXJyZW50VGFyZ2V0LmdldE1vZGVsKClcbiAgICAgICAgKVxuICAgIH0sXG4gICAgJ3NldC1icmVhay1vbi1leGNlcHRpb24nOiBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IHNlbGVjdERlYnVnTW9kZVZpZXcgPSByZXF1aXJlKCcuL3ZpZXdzL1NlbGVjdERlYnVnTW9kZVZpZXcnKVxuICAgICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBzZWxlY3REZWJ1Z01vZGVWaWV3KGRlYnVnTW9kZXMsIGF0b20uY29uZmlnLmdldCgnaGFza2VsbC1kZWJ1Zy5icmVha09uRXhjZXB0aW9uJykpXG4gICAgICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkgeyBhdG9tLmNvbmZpZy5zZXQoJ2hhc2tlbGwtZGVidWcuYnJlYWtPbkV4Y2VwdGlvbicsIHJlc3VsdCkgfVxuICAgIH1cbn1cblxuZnVuY3Rpb24gb25GaXJzdFJ1biAoKSB7XG4gICAgc3RhdGUgPSB7XG4gICAgICAgIHByb3Blcmx5QWN0aXZhdGVkOiBmYWxzZVxuICAgIH1cblxuICAgIC8vIGZyb20gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL3F1ZXN0aW9ucy8zNDk1MzE2OC9ub2RlLWNoZWNrLWV4aXN0ZW5jZS1vZi1jb21tYW5kLWluLXBhdGhcbiAgICBjb25zdCBpc1dpbiA9IG9zLnBsYXRmb3JtKCkuaW5kZXhPZignd2luJykgPiAtMVxuICAgIGNvbnN0IHdoZXJlID0gaXNXaW4gPyAnd2hlcmUnIDogJ3doZXJlaXMnXG5cbiAgICBjb25zdCBvdXQgPSBjcC5leGVjKHdoZXJlICsgJyBub2RlJylcblxuICAgIG91dC5vbignY2xvc2UnLCAoY29kZSkgPT4ge1xuICAgICAgICBpZiAoY29kZSA9PT0gMSkgey8vIG5vdCBmb3VuZFxuICAgICAgICAgICAgLy8gZmFsbGJhY2sgdG8gdGhlIG5vZGUgaW4gYXBtXG4gICAgICAgICAgICBhdG9tLmNvbmZpZy5zZXQoJ2hhc2tlbGwtZGVidWcubm9kZUNvbW1hbmQnLCBwYXRoLnJlc29sdmUoYXRvbS5wYWNrYWdlcy5nZXRBcG1QYXRoKCksICcuLi8uLi9iaW4vYXRvbScpKVxuICAgICAgICAgICAgaWYgKHN0YXRlKSB7IHN0YXRlLnByb3Blcmx5QWN0aXZhdGVkID0gdHJ1ZSB9XG4gICAgICAgIH1cbiAgICB9KVxufVxuXG5mdW5jdGlvbiBhY3RpdmVQYW5lT2JzZXJ2ZXIgKHBhbmU6IGF0b21BUEkuUGFuZSkge1xuICAgIGlmIChhdG9tLndvcmtzcGFjZS5pc1RleHRFZGl0b3IocGFuZSkpIHtcbiAgICAgICAgY29uc3QgdGU6IGF0b21BUEkuVGV4dEVkaXRvciAmIHsgaGFzSGFza2VsbEJyZWFrcG9pbnRzPzogYm9vbGVhbiB9ID0gcGFuZVxuICAgICAgICBjb25zdCBzY29wZXMgPSB0ZS5nZXRSb290U2NvcGVEZXNjcmlwdG9yKCkuZ2V0U2NvcGVzQXJyYXkoKVxuICAgICAgICBpZiAoc2NvcGVzLmxlbmd0aCA9PT0gMSAmJiBzY29wZXNbMF0gPT09ICdzb3VyY2UuaGFza2VsbCcpIHtcbiAgICAgICAgICAgIGlmICghdGUuaGFzSGFza2VsbEJyZWFrcG9pbnRzKSB7XG4gICAgICAgICAgICAgICAgYnJlYWtwb2ludFVJLmF0dGFjaFRvTmV3VGV4dEVkaXRvcih0ZSlcbiAgICAgICAgICAgICAgICB0ZS5oYXNIYXNrZWxsQnJlYWtwb2ludHMgPSB0cnVlXG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZGVidWdnZXJJbnN0KSB7XG4gICAgICAgICAgICAgICAgZGVidWdnZXJJbnN0LnNob3dQYW5lbHMoKVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuICAvLyBkb24ndCBkbyBiZWxvd1xuICAgICAgICB9XG4gICAgfVxuICAgIC8vIGlmIGFueSBwYW5lIHRoYXQgaXNuJ3QgYSBoYXNrZWxsIHNvdXJjZSBmaWxlIGFuZCB3ZSdyZSBkZWJ1Z2dpbmdcbiAgICBpZiAoZGVidWdnZXJJbnN0KSB7XG4gICAgICAgIGRlYnVnZ2VySW5zdC5oaWRlUGFuZWxzKClcbiAgICB9XG59XG5cbmludGVyZmFjZSBIYXNrZWxsRGVidWdTdGF0ZSB7XG4gICAgcHJvcGVybHlBY3RpdmF0ZWQ6IGJvb2xlYW5cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFjdGl2YXRlIChfc3RhdGU/OiBIYXNrZWxsRGVidWdTdGF0ZSkge1xuICAgIGRpc3Bvc2FibGVzID0gbmV3IGF0b21BUEkuQ29tcG9zaXRlRGlzcG9zYWJsZSgpXG4gICAgc3RhdGUgPSBfc3RhdGVcblxuICAgIGlmIChzdGF0ZSA9PT0gdW5kZWZpbmVkIHx8IHN0YXRlLnByb3Blcmx5QWN0aXZhdGVkICE9PSB0cnVlKSB7XG4gICAgICAgIG9uRmlyc3RSdW4oKVxuICAgIH1cbiAgICBkaXNwb3NhYmxlcy5hZGQoYXRvbS53b3Jrc3BhY2Uub2JzZXJ2ZUFjdGl2ZVBhbmVJdGVtKGFjdGl2ZVBhbmVPYnNlcnZlcikpXG5cbiAgICBmb3IgKGNvbnN0IGNvbW1hbmQgb2YgT2JqZWN0LmtleXMoY29tbWFuZHMpKSB7XG4gICAgICBkaXNwb3NhYmxlcy5hZGQoXG4gICAgICAgIGF0b20uY29tbWFuZHMuYWRkKFwiYXRvbS10ZXh0LWVkaXRvcltkYXRhLWdyYW1tYXI9J3NvdXJjZSBoYXNrZWxsJ11cIixcbiAgICAgICAgICAgICAgICAgICAgICAgICAgJ2hhc2tlbGw6JyArIGNvbW1hbmQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1hbmRzW2NvbW1hbmRdKVxuICAgICAgKVxuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlYWN0aXZhdGUgKCkge1xuICAgIGRpc3Bvc2FibGVzICYmIGRpc3Bvc2FibGVzLmRpc3Bvc2UoKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc2VyaWFsaXplICgpIHtcbiAgICByZXR1cm4gc3RhdGVcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbnN1bWVIYXNrZWxsVXBpIChyZWc6IFVQSS5JVVBJUmVnaXN0cmF0aW9uKSB7XG4gICAgY29uc3QgdG9vbHRpcE92ZXJyaWRlID0gbmV3IFRvb2x0aXBPdmVycmlkZShhc3luYyAoZXhwcmVzc2lvbikgPT4ge1xuICAgICAgICBpZiAoZGVidWdnZXJJbnN0ID09PSB1bmRlZmluZWQpIHsgcmV0dXJuIH1cbiAgICAgICAgcmV0dXJuIGRlYnVnZ2VySW5zdC5yZXNvbHZlRXhwcmVzc2lvbihleHByZXNzaW9uKVxuICAgIH0pXG4gICAgdXBpID0gcmVnKHtcbiAgICAgIG5hbWU6ICdoYXNrZWxsLWRlYnVnJyxcbiAgICAgIHRvb2x0aXA6IHtcbiAgICAgICAgcHJpb3JpdHk6IDEwMCxcbiAgICAgICAgaGFuZGxlcjogdG9vbHRpcE92ZXJyaWRlLnRvb2x0aXBIYW5kbGVyLmJpbmQodG9vbHRpcE92ZXJyaWRlKVxuICAgICAgfVxuICAgIH0pXG4gICAgcmV0dXJuIHVwaVxufVxuIl19