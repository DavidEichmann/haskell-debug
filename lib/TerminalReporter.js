"use strict";
const cp = require("child_process");
const net = require("net");
const os = require("os");
const util = require("util");
const atomAPI = require("atom");
const PIPE_PATH = 'haskell-debug';
class TerminalReporter {
    constructor() {
        this.emitter = new atomAPI.Emitter();
        this.on = this.emitter.on.bind(this.emitter);
        this.streamData = '';
        this.totalData = '';
        const connectionPath = os.platform() === 'win32' ?
            '\\\\.\\pipe\\' + PIPE_PATH : `/tmp/${PIPE_PATH}.sock`;
        const terminalEchoPath = `${__dirname}/../bin/TerminalEcho.js`;
        this.server = net.createServer((socket) => {
            this.socket = socket;
            if (this.streamData !== '') {
                this.socket.write(this.streamData);
            }
            socket.on('data', (data) => this.onData(data));
            socket.on('end', () => {
                this.emitter.emit('close', undefined);
            });
        });
        this.server.listen(connectionPath, () => {
            if (atom.config.get('haskell-debug.showTerminal')) {
                const nodeCommand = `${atom.config.get('haskell-debug.nodeCommand')} ${terminalEchoPath}`;
                const commandToRun = util.format(atom.config.get('haskell-debug.terminalCommand'), nodeCommand);
                this.process = cp.exec(commandToRun);
            }
        });
    }
    destroy() {
        if (this.process) {
            this.send({
                type: 'close'
            });
            this.process.kill();
        }
        this.server.close();
    }
    prompt() {
        this.send({
            type: 'user-input'
        });
    }
    write(output) {
        this.send({
            type: 'message',
            content: output
        });
    }
    displayCommand(command) {
        this.send({
            type: 'display-command',
            command
        });
    }
    send(data) {
        try {
            const sendingData = JSON.stringify(data) + '\n';
            if (this.socket === undefined) {
                this.streamData += sendingData;
            }
            else {
                this.socket.write(sendingData);
            }
        }
        catch (e) {
        }
    }
    onData(data) {
        const newLinePos = data.indexOf('\n');
        if (newLinePos !== -1) {
            this.totalData += data.slice(0, newLinePos);
            this.emitter.emit('command', this.totalData);
            this.totalData = '';
            this.onData(data.slice(newLinePos + 1));
        }
        else {
            this.totalData += data;
        }
    }
}
module.exports = TerminalReporter;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiVGVybWluYWxSZXBvcnRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9saWIvVGVybWluYWxSZXBvcnRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsb0NBQW9DO0FBQ3BDLDJCQUEyQjtBQUMzQix5QkFBeUI7QUFDekIsNkJBQTZCO0FBQzdCLGdDQUFnQztBQUdoQyxNQUFNLFNBQVMsR0FBRyxlQUFlLENBQUE7QUFFakM7SUFjRTtRQWJRLFlBQU8sR0FHVixJQUFJLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQTtRQUVWLE9BQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBSy9DLGVBQVUsR0FBRyxFQUFFLENBQUE7UUFDZixjQUFTLEdBQUcsRUFBRSxDQUFBO1FBR3BCLE1BQU0sY0FBYyxHQUFHLEVBQUUsQ0FBQyxRQUFRLEVBQUUsS0FBSyxPQUFPO1lBQzlDLGVBQWUsR0FBRyxTQUFTLEdBQUcsUUFBUSxTQUFTLE9BQU8sQ0FBQTtRQUN4RCxNQUFNLGdCQUFnQixHQUFHLEdBQUcsU0FBUyx5QkFBeUIsQ0FBQTtRQUU5RCxJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxZQUFZLENBQUMsQ0FBQyxNQUFNO1lBQ3BDLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFBO1lBQ3BCLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxVQUFVLEtBQUssRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDM0IsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFBO1lBQ3BDLENBQUM7WUFDRCxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksS0FBSyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUE7WUFDOUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVB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LENBQUM7UUFBQyxJQUFJLENBQUMsQ0FBQztZQUNOLElBQUksQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFBO1FBQ3hCLENBQUM7SUFDSCxDQUFDO0NBQ0Y7QUFFRCxpQkFBUyxnQkFBZ0IsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjcCA9IHJlcXVpcmUoJ2NoaWxkX3Byb2Nlc3MnKVxuaW1wb3J0IG5ldCA9IHJlcXVpcmUoJ25ldCcpXG5pbXBvcnQgb3MgPSByZXF1aXJlKCdvcycpXG5pbXBvcnQgdXRpbCA9IHJlcXVpcmUoJ3V0aWwnKVxuaW1wb3J0IGF0b21BUEkgPSByZXF1aXJlKCdhdG9tJylcbmltcG9ydCB7TWVzc2FnZX0gZnJvbSAnLi4vYmluL21lc3NhZ2UnXG5cbmNvbnN0IFBJUEVfUEFUSCA9ICdoYXNrZWxsLWRlYnVnJ1xuXG5jbGFzcyBUZXJtaW5hbFJlcG9ydGVyIHtcbiAgcHJpdmF0ZSBlbWl0dGVyOiBhdG9tQVBJLlRFbWl0dGVyPHtcbiAgICAnY29tbWFuZCc6IHN0cmluZ1xuICAgICdjbG9zZSc6IHVuZGVmaW5lZFxuICB9PiA9IG5ldyBhdG9tQVBJLkVtaXR0ZXIoKVxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG1lbWJlci1vcmRlcmluZ1xuICBwdWJsaWMgcmVhZG9ubHkgb24gPSB0aGlzLmVtaXR0ZXIub24uYmluZCh0aGlzLmVtaXR0ZXIpXG5cbiAgcHJpdmF0ZSBwcm9jZXNzPzogY3AuQ2hpbGRQcm9jZXNzXG4gIHByaXZhdGUgc2VydmVyOiBuZXQuU2VydmVyXG4gIHByaXZhdGUgc29ja2V0PzogbmV0LlNvY2tldFxuICBwcml2YXRlIHN0cmVhbURhdGEgPSAnJ1xuICBwcml2YXRlIHRvdGFsRGF0YSA9ICcnXG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgY29uc3QgY29ubmVjdGlvblBhdGggPSBvcy5wbGF0Zm9ybSgpID09PSAnd2luMzInID9cbiAgICAgICdcXFxcXFxcXC5cXFxccGlwZVxcXFwnICsgUElQRV9QQVRIIDogYC90bXAvJHtQSVBFX1BBVEh9LnNvY2tgXG4gICAgY29uc3QgdGVybWluYWxFY2hvUGF0aCA9IGAke19fZGlybmFtZX0vLi4vYmluL1Rlcm1pbmFsRWNoby5qc2BcblxuICAgIHRoaXMuc2VydmVyID0gbmV0LmNyZWF0ZVNlcnZlcigoc29ja2V0KSA9PiB7XG4gICAgICB0aGlzLnNvY2tldCA9IHNvY2tldFxuICAgICAgaWYgKHRoaXMuc3RyZWFtRGF0YSAhPT0gJycpIHtcbiAgICAgICAgdGhpcy5zb2NrZXQud3JpdGUodGhpcy5zdHJlYW1EYXRhKVxuICAgICAgfVxuICAgICAgc29ja2V0Lm9uKCdkYXRhJywgKGRhdGEpID0+IHRoaXMub25EYXRhKGRhdGEpKVxuICAgICAgc29ja2V0Lm9uKCdlbmQnLCAoKSA9PiB7XG4gICAgICAgIHRoaXMuZW1pdHRlci5lbWl0KCdjbG9zZScsIHVuZGVmaW5lZClcbiAgICAgIH0pXG4gICAgfSlcblxuICAgIHRoaXMuc2VydmVyLmxpc3Rlbihjb25uZWN0aW9uUGF0aCwgKCkgPT4ge1xuICAgICAgaWYgKGF0b20uY29uZmlnLmdldCgnaGFza2VsbC1kZWJ1Zy5zaG93VGVybWluYWwnKSkge1xuICAgICAgICBjb25zdCBub2RlQ29tbWFuZCA9IGAke2F0b20uY29uZmlnLmdldCgnaGFza2VsbC1kZWJ1Zy5ub2RlQ29tbWFuZCcpfSAke3Rlcm1pbmFsRWNob1BhdGh9YFxuICAgICAgICBjb25zdCBjb21tYW5kVG9SdW4gPSB1dGlsLmZvcm1hdChhdG9tLmNvbmZpZy5nZXQoJ2hhc2tlbGwtZGVidWcudGVybWluYWxDb21tYW5kJyksIG5vZGVDb21tYW5kKVxuXG4gICAgICAgIHRoaXMucHJvY2VzcyA9IGNwLmV4ZWMoY29tbWFuZFRvUnVuKVxuICAgICAgfVxuICAgIH0pXG4gIH1cblxuICBwdWJsaWMgZGVzdHJveSgpIHtcbiAgICBpZiAodGhpcy5wcm9jZXNzKSB7XG4gICAgICB0aGlzLnNlbmQoe1xuICAgICAgICB0eXBlOiAnY2xvc2UnXG4gICAgICB9KVxuICAgICAgdGhpcy5wcm9jZXNzLmtpbGwoKVxuICAgIH1cbiAgICB0aGlzLnNlcnZlci5jbG9zZSgpXG4gIH1cblxuICBwdWJsaWMgcHJvbXB0KCkge1xuICAgIHRoaXMuc2VuZCh7XG4gICAgICB0eXBlOiAndXNlci1pbnB1dCdcbiAgICB9KVxuICB9XG5cbiAgcHVibGljIHdyaXRlKG91dHB1dDogc3RyaW5nKSB7XG4gICAgdGhpcy5zZW5kKHtcbiAgICAgIHR5cGU6ICdtZXNzYWdlJyxcbiAgICAgIGNvbnRlbnQ6IG91dHB1dFxuICAgIH0pXG4gIH1cblxuICBwdWJsaWMgZGlzcGxheUNvbW1hbmQoY29tbWFuZDogc3RyaW5nKSB7XG4gICAgdGhpcy5zZW5kKHtcbiAgICAgIHR5cGU6ICdkaXNwbGF5LWNvbW1hbmQnLFxuICAgICAgY29tbWFuZFxuICAgIH0pXG4gIH1cblxuICBwcml2YXRlIHNlbmQoZGF0YTogTWVzc2FnZSkge1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBzZW5kaW5nRGF0YSA9IEpTT04uc3RyaW5naWZ5KGRhdGEpICsgJ1xcbidcblxuICAgICAgaWYgKHRoaXMuc29ja2V0ID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhpcy5zdHJlYW1EYXRhICs9IHNlbmRpbmdEYXRhXG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnNvY2tldC53cml0ZShzZW5kaW5nRGF0YSlcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAvLyBpZ25vcmUgZXJyb3NcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG9uRGF0YShkYXRhOiBCdWZmZXIpIHtcbiAgICBjb25zdCBuZXdMaW5lUG9zID0gZGF0YS5pbmRleE9mKCdcXG4nKVxuICAgIGlmIChuZXdMaW5lUG9zICE9PSAtMSkge1xuICAgICAgdGhpcy50b3RhbERhdGEgKz0gZGF0YS5zbGljZSgwLCBuZXdMaW5lUG9zKVxuICAgICAgdGhpcy5lbWl0dGVyLmVtaXQoJ2NvbW1hbmQnLCB0aGlzLnRvdGFsRGF0YSlcbiAgICAgIHRoaXMudG90YWxEYXRhID0gJydcbiAgICAgIHRoaXMub25EYXRhKGRhdGEuc2xpY2UobmV3TGluZVBvcyArIDEpKVxuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnRvdGFsRGF0YSArPSBkYXRhXG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCA9IFRlcm1pbmFsUmVwb3J0ZXJcbiJdfQ==