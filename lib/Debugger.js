"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
const atomAPI = require("atom");
const _GHCIDebug = require("./GHCIDebug");
const DebugView = require("./views/DebugView");
const CurrentVariablesView = require("./views/CurrentVariablesView");
const HistoryState = require("./HistoryState");
const LineHighlighter = require("./LineHighlighter");
const TerminalReporter = require("./TerminalReporter");
var GHCIDebug = _GHCIDebug.GHCIDebug;
const path = require("path");
class Debugger {
    constructor(breakpoints, ideCabalBuilderCommand) {
        this.ideCabalBuilderCommand = ideCabalBuilderCommand;
        this.lineHighlighter = new LineHighlighter();
        this.ghciDebug = new GHCIDebug(this.getGhciCommand(), this.getGhciArgs(), Debugger.getWorkingFolder());
        this.debugView = new DebugView();
        this.historyState = new HistoryState();
        this.currentVariablesView = new CurrentVariablesView();
        this.terminalReporter = new TerminalReporter();
        this.disposables = new atomAPI.CompositeDisposable();
        this.debuggerEnabled = false;
        this.executingCommandFromConsole = false;
        this.launchGHCIDebugAndConsole(breakpoints);
        this.displayGUI();
        this.disposables.add(atom.config.onDidChange("haskell-debug.breakOnException", ({ newValue }) => {
            this.ghciDebug.setExceptionBreakLevel(newValue);
        }));
    }
    getGhciCommand() {
        if (atom.config.get("haskell-debug.useIdeHaskellCabalBuilder")) {
            switch (this.ideCabalBuilderCommand) {
                case "cabal":
                    return "cabal";
                case "stack":
                    return "stack";
                default:
                    return atom.config.get("haskell-debug.GHCICommand");
            }
        }
        return atom.config.get("haskell-debug.GHCICommand");
    }
    getGhciArgs() {
        const args = [];
        const ghciArgs = atom.config.get("haskell-debug.GHCIArguments");
        if (atom.config.get("haskell-debug.useIdeHaskellCabalBuilder")) {
            switch (this.ideCabalBuilderCommand) {
                case "cabal":
                    args.push("repl");
                    break;
                case "stack":
                    args.push("ghci");
                    break;
            }
        }
        if (ghciArgs.length > 0
            && (this.ideCabalBuilderCommand == "cabal"
                || this.ideCabalBuilderCommand == "stack")) {
            return args.concat(`--ghc-options="${atom.config.get("haskell-debug.GHCIArguments")}"`);
        }
        else {
            return args.concat(atom.config.get("haskell-debug.GHCIArguments").split(" "));
        }
    }
    destroy() {
        this.lineHighlighter.destroy();
        if (this.ghciDebug)
            this.ghciDebug.destroy();
        this.debugView.destroy();
        this.debugPanel.destroy();
        this.currentVariablesPanel.destroy();
        this.currentVariablesView.destroy();
        this.terminalReporter.destroy();
        this.disposables.dispose();
    }
    hidePanels() {
        this.debugPanel.hide();
        this.currentVariablesPanel.hide();
    }
    showPanels() {
        this.debugPanel.show();
        this.currentVariablesPanel.show();
    }
    displayGUI() {
        this.debugView = new DebugView();
        this.debugPanel = atom.workspace.addTopPanel({
            item: this.debugView.element
        });
        this.debugView.emitter.on("step", () => this.step());
        this.debugView.emitter.on("back", () => this.back());
        this.debugView.emitter.on("forward", () => this.forward());
        this.debugView.emitter.on("continue", () => this.continue());
        this.debugView.emitter.on("stop", () => this.stop());
        this.currentVariablesView = new CurrentVariablesView();
        this.currentVariablesPanel = atom.workspace.addTopPanel({
            item: this.currentVariablesView.element
        });
    }
    updateHistoryLengthAndEnableButtons(historyLength) {
        if (historyLength !== undefined) {
            this.historyState.setMaxPosition(historyLength);
        }
        this.debugView.enableAllDebugButtons();
        this.debugView.buttons.back.isEnabled = this.historyState.backEnabled;
        this.debugView.buttons.forward.isEnabled = this.historyState.forwardEnabled;
        this.debuggerEnabled = true;
    }
    launchGHCIDebugAndConsole(breakpoints) {
        this.ghciDebug.emitter.on("line-changed", (info) => {
            this.lineHighlighter.hightlightLine(info);
            this.updateHistoryLengthAndEnableButtons(info.historyLength);
            this.currentVariablesView.update(info.localBindings, false);
        });
        this.ghciDebug.emitter.on("paused-on-exception", (info) => {
            this.lineHighlighter.destroy();
            this.updateHistoryLengthAndEnableButtons(info.historyLength);
            this.currentVariablesView.update(info.localBindings, true);
        });
        this.ghciDebug.emitter.on("debug-finished", () => {
            this.ghciDebug = null;
            this.destroy();
        });
        this.ghciDebug.emitter.on("command-issued", (command) => {
            if (!this.executingCommandFromConsole)
                this.terminalReporter.displayCommand(command);
            this.debuggerEnabled = false;
            setTimeout(() => {
                if (!this.debuggerEnabled)
                    this.debugView.disableAllDebugButtons();
            }, 100);
        });
        this.ghciDebug.emitter.on("console-output", (output) => {
            this.terminalReporter.write(output);
        });
        this.ghciDebug.emitter.on("error-completed", (errorText) => {
            if (!this.executingCommandFromConsole)
                atom.notifications.addError("GHCI Error", {
                    detail: errorText,
                    dismissable: true
                });
        });
        this.ghciDebug.emitter.on("error", (errorText) => {
            this.terminalReporter.write(errorText);
        });
        this.ghciDebug.addedAllListeners();
        this.terminalReporter.emitter.on("command", (command) => __awaiter(this, void 0, void 0, function* () {
            this.executingCommandFromConsole = true;
            yield this.ghciDebug.run(command, true, true);
            this.executingCommandFromConsole = false;
        }));
        this.terminalReporter.emitter.on("close", () => {
            if (this.ghciDebug != null)
                this.ghciDebug.stop();
        });
        this.ghciDebug.setExceptionBreakLevel(atom.config.get("haskell-debug.breakOnException"));
        this.debugView.disableAllDebugButtons();
        var fileToDebug = atom.workspace.getActiveTextEditor().getPath();
        this.ghciDebug.loadModule(fileToDebug);
        breakpoints.forEach(ob => {
            if (ob.file == fileToDebug)
                this.ghciDebug.addBreakpoint(ob.line.toString());
            else
                this.ghciDebug.addBreakpoint(ob);
        });
        this.ghciDebug.startDebug(atom.config.get("haskell-debug.functionToDebug"));
    }
    resolveExpression(expression) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.ghciDebug.resolveExpression(expression);
        });
    }
    back() {
        if (this.historyState.setCurrentPosition(this.historyState.getCurrentPosition() + 1))
            this.ghciDebug.back();
    }
    forward() {
        if (this.historyState.setCurrentPosition(this.historyState.getCurrentPosition() - 1))
            this.ghciDebug.forward();
    }
    continue() {
        this.ghciDebug.continue();
    }
    step() {
        this.ghciDebug.step();
    }
    stop() {
        this.ghciDebug.stop();
    }
    static getWorkingFolder() {
        const fileToDebug = atom.workspace.getActiveTextEditor().getPath();
        return path.dirname(fileToDebug);
    }
}
module.exports = Debugger;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGVidWdnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvRGVidWdnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsZ0NBQWlDO0FBQ2pDLDBDQUEyQztBQUMzQywrQ0FBZ0Q7QUFDaEQscUVBQXNFO0FBRXRFLCtDQUFnRDtBQUNoRCxxREFBc0Q7QUFDdEQsdURBQXdEO0FBQ3hELElBQU8sU0FBUyxHQUFHLFVBQVUsQ0FBQyxTQUFTLENBQUM7QUFHeEMsNkJBQThCO0FBRTlCO0lBbUxJLFlBQVksV0FBeUIsRUFBVSxzQkFBK0I7UUFBL0IsMkJBQXNCLEdBQXRCLHNCQUFzQixDQUFTO1FBbEx0RSxvQkFBZSxHQUFHLElBQUksZUFBZSxFQUFFLENBQUM7UUFDeEMsY0FBUyxHQUFHLElBQUksU0FBUyxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsRUFBRSxJQUFJLENBQUMsV0FBVyxFQUFFLEVBQUUsUUFBUSxDQUFDLGdCQUFnQixFQUFFLENBQUMsQ0FBQztRQUNsRyxjQUFTLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQztRQUM1QixpQkFBWSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFFbEMseUJBQW9CLEdBQUcsSUFBSSxvQkFBb0IsRUFBRSxDQUFDO1FBRWxELHFCQUFnQixHQUFHLElBQUksZ0JBQWdCLEVBQUUsQ0FBQztRQUMxQyxnQkFBVyxHQUFHLElBQUksT0FBTyxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFpRmhELG9CQUFlLEdBQUcsS0FBSyxDQUFDO1FBYXhCLGdDQUEyQixHQUFHLEtBQUssQ0FBQztRQTZFeEMsSUFBSSxDQUFDLHlCQUF5QixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztRQUNsQixJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxnQ0FBZ0MsRUFBRSxDQUFDLEVBQUMsUUFB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Q0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDMUIsQ0FBQztJQUVPLE1BQU0sQ0FBQyxnQkFBZ0I7UUFFM0IsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ25FLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ3JDLENBQUM7Q0FDSjtBQUVELGlCQUFTLFFBQVEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBhdG9tQVBJID0gcmVxdWlyZShcImF0b21cIik7XG5pbXBvcnQgX0dIQ0lEZWJ1ZyA9IHJlcXVpcmUoXCIuL0dIQ0lEZWJ1Z1wiKTtcbmltcG9ydCBEZWJ1Z1ZpZXcgPSByZXF1aXJlKFwiLi92aWV3cy9EZWJ1Z1ZpZXdcIik7XG5pbXBvcnQgQ3VycmVudFZhcmlhYmxlc1ZpZXcgPSByZXF1aXJlKFwiLi92aWV3cy9DdXJyZW50VmFyaWFibGVzVmlld1wiKTtcbmltcG9ydCBCcmVha3BvaW50VUkgPSByZXF1aXJlKFwiLi9CcmVha3BvaW50VUlcIik7XG5pbXBvcnQgSGlzdG9yeVN0YXRlID0gcmVxdWlyZShcIi4vSGlzdG9yeVN0YXRlXCIpO1xuaW1wb3J0IExpbmVIaWdobGlnaHRlciA9IHJlcXVpcmUoXCIuL0xpbmVIaWdobGlnaHRlclwiKTtcbmltcG9ydCBUZXJtaW5hbFJlcG9ydGVyID0gcmVxdWlyZShcIi4vVGVybWluYWxSZXBvcnRlclwiKTtcbmltcG9ydCBHSENJRGVidWcgPSBfR0hDSURlYnVnLkdIQ0lEZWJ1ZztcbmltcG9ydCBCcmVha0luZm8gPSBfR0hDSURlYnVnLkJyZWFrSW5mbztcbmltcG9ydCBFeGNlcHRpb25JbmZvID0gX0dIQ0lEZWJ1Zy5FeGNlcHRpb25JbmZvO1xuaW1wb3J0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcblxuY2xhc3MgRGVidWdnZXJ7XG4gICAgcHJpdmF0ZSBsaW5lSGlnaGxpZ2h0ZXIgPSBuZXcgTGluZUhpZ2hsaWdodGVyKCk7XG4gICAgcHJpdmF0ZSBnaGNpRGVidWcgPSBuZXcgR0hDSURlYnVnKHRoaXMuZ2V0R2hjaUNvbW1hbmQoKSwgdGhpcy5nZXRHaGNpQXJncygpLCBEZWJ1Z2dlci5nZXRXb3JraW5nRm9sZGVyKCkpO1xuICAgIHByaXZhdGUgZGVidWdWaWV3ID0gbmV3IERlYnVnVmlldygpO1xuICAgIHByaXZhdGUgaGlzdG9yeVN0YXRlID0gbmV3IEhpc3RvcnlTdGF0ZSgpO1xuICAgIHByaXZhdGUgZGVidWdQYW5lbDogQXRvbUNvcmUuUGFuZWw7XG4gICAgcHJpdmF0ZSBjdXJyZW50VmFyaWFibGVzVmlldyA9IG5ldyBDdXJyZW50VmFyaWFibGVzVmlldygpO1xuICAgIHByaXZhdGUgY3VycmVudFZhcmlhYmxlc1BhbmVsOiBBdG9tQ29yZS5QYW5lbDtcbiAgICBwcml2YXRlIHRlcm1pbmFsUmVwb3J0ZXIgPSBuZXcgVGVybWluYWxSZXBvcnRlcigpO1xuICAgIHByaXZhdGUgZGlzcG9zYWJsZXMgPSBuZXcgYXRvbUFQSS5Db21wb3NpdGVEaXNwb3NhYmxlKCk7XG5cbiAgICBwcml2YXRlIGdldEdoY2lDb21tYW5kKCl7XG4gICAgICAgIGlmKGF0b20uY29uZmlnLmdldChcImhhc2tlbGwtZGVidWcudXNlSWRlSGFza2VsbENhYmFsQnVpbGRlclwiKSl7XG4gICAgICAgICAgICBzd2l0Y2godGhpcy5pZGVDYWJhbEJ1aWxkZXJDb21tYW5kKXtcbiAgICAgICAgICAgICAgICBjYXNlIFwiY2FiYWxcIjpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFwiY2FiYWxcIjtcbiAgICAgICAgICAgICAgICBjYXNlIFwic3RhY2tcIjpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFwic3RhY2tcIjtcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYXRvbS5jb25maWcuZ2V0KFwiaGFza2VsbC1kZWJ1Zy5HSENJQ29tbWFuZFwiKVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhdG9tLmNvbmZpZy5nZXQoXCJoYXNrZWxsLWRlYnVnLkdIQ0lDb21tYW5kXCIpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0R2hjaUFyZ3MoKXtcbiAgICAgICAgY29uc3QgYXJncyA9IFtdO1xuICAgICAgICBjb25zdCBnaGNpQXJncyA9IGF0b20uY29uZmlnLmdldChcImhhc2tlbGwtZGVidWcuR0hDSUFyZ3VtZW50c1wiKTtcblxuICAgICAgICBpZihhdG9tLmNvbmZpZy5nZXQoXCJoYXNrZWxsLWRlYnVnLnVzZUlkZUhhc2tlbGxDYWJhbEJ1aWxkZXJcIikpe1xuICAgICAgICAgICAgc3dpdGNoKHRoaXMuaWRlQ2FiYWxCdWlsZGVyQ29tbWFuZCl7XG4gICAgICAgICAgICAgICAgY2FzZSBcImNhYmFsXCI6XG4gICAgICAgICAgICAgICAgICAgIGFyZ3MucHVzaChcInJlcGxcIik7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgXCJzdGFja1wiOlxuICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goXCJnaGNpXCIpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgaWYoZ2hjaUFyZ3MubGVuZ3RoID4gMFxuICAgICAgICAgICAgJiYgKHRoaXMuaWRlQ2FiYWxCdWlsZGVyQ29tbWFuZCA9PSBcImNhYmFsXCJcbiAgICAgICAgICAgIHx8ICB0aGlzLmlkZUNhYmFsQnVpbGRlckNvbW1hbmQgPT0gXCJzdGFja1wiKSl7XG4gICAgICAgICAgICByZXR1cm4gYXJncy5jb25jYXQoYC0tZ2hjLW9wdGlvbnM9XCIke2F0b20uY29uZmlnLmdldChcImhhc2tlbGwtZGVidWcuR0hDSUFyZ3VtZW50c1wiKX1cImApXG4gICAgICAgIH1cbiAgICAgICAgZWxzZXtcbiAgICAgICAgICAgIHJldHVybiBhcmdzLmNvbmNhdChhdG9tLmNvbmZpZy5nZXQoXCJoYXNrZWxsLWRlYnVnLkdIQ0lBcmd1bWVudHNcIikuc3BsaXQoXCIgXCIpKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgZGVzdHJveSgpe1xuICAgICAgICB0aGlzLmxpbmVIaWdobGlnaHRlci5kZXN0cm95KCk7XG4gICAgICAgIGlmKHRoaXMuZ2hjaURlYnVnKVxuICAgICAgICAgICAgdGhpcy5naGNpRGVidWcuZGVzdHJveSgpO1xuICAgICAgICB0aGlzLmRlYnVnVmlldy5kZXN0cm95KCk7XG4gICAgICAgIHRoaXMuZGVidWdQYW5lbC5kZXN0cm95KCk7XG4gICAgICAgIHRoaXMuY3VycmVudFZhcmlhYmxlc1BhbmVsLmRlc3Ryb3koKTtcbiAgICAgICAgdGhpcy5jdXJyZW50VmFyaWFibGVzVmlldy5kZXN0cm95KCk7XG4gICAgICAgIHRoaXMudGVybWluYWxSZXBvcnRlci5kZXN0cm95KCk7XG4gICAgICAgIHRoaXMuZGlzcG9zYWJsZXMuZGlzcG9zZSgpO1xuICAgIH1cblxuICAgIGhpZGVQYW5lbHMoKXtcbiAgICAgICAgdGhpcy5kZWJ1Z1BhbmVsLmhpZGUoKTtcbiAgICAgICAgdGhpcy5jdXJyZW50VmFyaWFibGVzUGFuZWwuaGlkZSgpO1xuICAgIH1cblxuICAgIHNob3dQYW5lbHMoKXtcbiAgICAgICAgdGhpcy5kZWJ1Z1BhbmVsLnNob3coKTtcbiAgICAgICAgdGhpcy5jdXJyZW50VmFyaWFibGVzUGFuZWwuc2hvdygpO1xuICAgIH1cblxuICAgIHByaXZhdGUgZGlzcGxheUdVSSgpe1xuICAgICAgICB0aGlzLmRlYnVnVmlldyA9IG5ldyBEZWJ1Z1ZpZXcoKTtcbiAgICAgICAgdGhpcy5kZWJ1Z1BhbmVsID0gYXRvbS53b3Jrc3BhY2UuYWRkVG9wUGFuZWwoe1xuICAgICAgICAgICAgaXRlbTogdGhpcy5kZWJ1Z1ZpZXcuZWxlbWVudFxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmRlYnVnVmlldy5lbWl0dGVyLm9uKFwic3RlcFwiLCAoKSA9PiB0aGlzLnN0ZXAoKSk7XG4gICAgICAgIHRoaXMuZGVidWdWaWV3LmVtaXR0ZXIub24oXCJiYWNrXCIsICgpID0+IHRoaXMuYmFjaygpKTtcbiAgICAgICAgdGhpcy5kZWJ1Z1ZpZXcuZW1pdHRlci5vbihcImZvcndhcmRcIiwgKCkgPT4gdGhpcy5mb3J3YXJkKCkpO1xuICAgICAgICB0aGlzLmRlYnVnVmlldy5lbWl0dGVyLm9uKFwiY29udGludWVcIiwgKCkgPT4gdGhpcy5jb250aW51ZSgpKTtcbiAgICAgICAgdGhpcy5kZWJ1Z1ZpZXcuZW1pdHRlci5vbihcInN0b3BcIiwgKCkgPT4gdGhpcy5zdG9wKCkpO1xuXG4gICAgICAgIHRoaXMuY3VycmVudFZhcmlhYmxlc1ZpZXcgPSBuZXcgQ3VycmVudFZhcmlhYmxlc1ZpZXcoKTtcbiAgICAgICAgdGhpcy5jdXJyZW50VmFyaWFibGVzUGFuZWwgPSBhdG9tLndvcmtzcGFjZS5hZGRUb3BQYW5lbCh7XG4gICAgICAgICAgICBpdGVtOiB0aGlzLmN1cnJlbnRWYXJpYWJsZXNWaWV3LmVsZW1lbnRcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBkZWJ1Z2dlckVuYWJsZWQgPSBmYWxzZTtcblxuICAgIHByaXZhdGUgdXBkYXRlSGlzdG9yeUxlbmd0aEFuZEVuYWJsZUJ1dHRvbnMoaGlzdG9yeUxlbmd0aDogbnVtYmVyKXtcbiAgICAgICAgaWYoaGlzdG9yeUxlbmd0aCAhPT0gdW5kZWZpbmVkKXtcbiAgICAgICAgICAgIHRoaXMuaGlzdG9yeVN0YXRlLnNldE1heFBvc2l0aW9uKGhpc3RvcnlMZW5ndGgpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5kZWJ1Z1ZpZXcuZW5hYmxlQWxsRGVidWdCdXR0b25zKCk7XG4gICAgICAgIHRoaXMuZGVidWdWaWV3LmJ1dHRvbnMuYmFjay5pc0VuYWJsZWQgPSB0aGlzLmhpc3RvcnlTdGF0ZS5iYWNrRW5hYmxlZDtcbiAgICAgICAgdGhpcy5kZWJ1Z1ZpZXcuYnV0dG9ucy5mb3J3YXJkLmlzRW5hYmxlZCA9IHRoaXMuaGlzdG9yeVN0YXRlLmZvcndhcmRFbmFibGVkO1xuICAgICAgICB0aGlzLmRlYnVnZ2VyRW5hYmxlZCA9IHRydWU7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBleGVjdXRpbmdDb21tYW5kRnJvbUNvbnNvbGUgPSBmYWxzZTtcbiAgICBwcml2YXRlIGxhdW5jaEdIQ0lEZWJ1Z0FuZENvbnNvbGUoYnJlYWtwb2ludHM6IEJyZWFrcG9pbnRbXSl7XG4gICAgICAgIHRoaXMuZ2hjaURlYnVnLmVtaXR0ZXIub24oXCJsaW5lLWNoYW5nZWRcIiwgKGluZm86IEJyZWFrSW5mbykgPT4ge1xuICAgICAgICAgICAgdGhpcy5saW5lSGlnaGxpZ2h0ZXIuaGlnaHRsaWdodExpbmUoaW5mbyk7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZUhpc3RvcnlMZW5ndGhBbmRFbmFibGVCdXR0b25zKGluZm8uaGlzdG9yeUxlbmd0aCk7XG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRWYXJpYWJsZXNWaWV3LnVwZGF0ZShpbmZvLmxvY2FsQmluZGluZ3MsIGZhbHNlKTtcbiAgICAgICAgfSlcblxuICAgICAgICB0aGlzLmdoY2lEZWJ1Zy5lbWl0dGVyLm9uKFwicGF1c2VkLW9uLWV4Y2VwdGlvblwiLCAoaW5mbzogRXhjZXB0aW9uSW5mbykgPT4ge1xuICAgICAgICAgICAgdGhpcy5saW5lSGlnaGxpZ2h0ZXIuZGVzdHJveSgpO1xuICAgICAgICAgICAgdGhpcy51cGRhdGVIaXN0b3J5TGVuZ3RoQW5kRW5hYmxlQnV0dG9ucyhpbmZvLmhpc3RvcnlMZW5ndGgpO1xuICAgICAgICAgICAgdGhpcy5jdXJyZW50VmFyaWFibGVzVmlldy51cGRhdGUoaW5mby5sb2NhbEJpbmRpbmdzLCB0cnVlKTtcbiAgICAgICAgfSlcblxuICAgICAgICB0aGlzLmdoY2lEZWJ1Zy5lbWl0dGVyLm9uKFwiZGVidWctZmluaXNoZWRcIiwgKCkgPT4ge1xuICAgICAgICAgICAgdGhpcy5naGNpRGVidWcgPSBudWxsO1xuICAgICAgICAgICAgdGhpcy5kZXN0cm95KClcbiAgICAgICAgfSlcblxuICAgICAgICB0aGlzLmdoY2lEZWJ1Zy5lbWl0dGVyLm9uKFwiY29tbWFuZC1pc3N1ZWRcIiwgKGNvbW1hbmQpID0+IHtcbiAgICAgICAgICAgIGlmKCF0aGlzLmV4ZWN1dGluZ0NvbW1hbmRGcm9tQ29uc29sZSlcbiAgICAgICAgICAgICAgICB0aGlzLnRlcm1pbmFsUmVwb3J0ZXIuZGlzcGxheUNvbW1hbmQoY29tbWFuZCk7XG5cbiAgICAgICAgICAgIHRoaXMuZGVidWdnZXJFbmFibGVkID0gZmFsc2U7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICBpZighdGhpcy5kZWJ1Z2dlckVuYWJsZWQpXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZGVidWdWaWV3LmRpc2FibGVBbGxEZWJ1Z0J1dHRvbnMoKTtcbiAgICAgICAgICAgIH0sIDEwMCk7XG4gICAgICAgIH0pXG5cbiAgICAgICAgdGhpcy5naGNpRGVidWcuZW1pdHRlci5vbihcImNvbnNvbGUtb3V0cHV0XCIsIChvdXRwdXQpID0+IHtcbiAgICAgICAgICAgIHRoaXMudGVybWluYWxSZXBvcnRlci53cml0ZShvdXRwdXQpO1xuICAgICAgICB9KVxuXG4gICAgICAgIHRoaXMuZ2hjaURlYnVnLmVtaXR0ZXIub24oXCJlcnJvci1jb21wbGV0ZWRcIiwgKGVycm9yVGV4dCkgPT4ge1xuICAgICAgICAgICAgaWYoIXRoaXMuZXhlY3V0aW5nQ29tbWFuZEZyb21Db25zb2xlKVxuICAgICAgICAgICAgICAgIGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihcIkdIQ0kgRXJyb3JcIiwge1xuICAgICAgICAgICAgICAgICAgICBkZXRhaWw6IGVycm9yVGV4dCxcbiAgICAgICAgICAgICAgICAgICAgZGlzbWlzc2FibGU6IHRydWVcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICB9KVxuXG4gICAgICAgIHRoaXMuZ2hjaURlYnVnLmVtaXR0ZXIub24oXCJlcnJvclwiLCAoZXJyb3JUZXh0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLnRlcm1pbmFsUmVwb3J0ZXIud3JpdGUoZXJyb3JUZXh0KTtcbiAgICAgICAgfSlcblxuICAgICAgICB0aGlzLmdoY2lEZWJ1Zy5hZGRlZEFsbExpc3RlbmVycygpO1xuXG4gICAgICAgIHRoaXMudGVybWluYWxSZXBvcnRlci5lbWl0dGVyLm9uKFwiY29tbWFuZFwiLCBhc3luYyBjb21tYW5kID0+IHtcbiAgICAgICAgICAgIHRoaXMuZXhlY3V0aW5nQ29tbWFuZEZyb21Db25zb2xlID0gdHJ1ZTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMuZ2hjaURlYnVnLnJ1bihjb21tYW5kLCB0cnVlLCB0cnVlKTtcbiAgICAgICAgICAgIHRoaXMuZXhlY3V0aW5nQ29tbWFuZEZyb21Db25zb2xlID0gZmFsc2U7XG4gICAgICAgIH0pXG5cbiAgICAgICAgdGhpcy50ZXJtaW5hbFJlcG9ydGVyLmVtaXR0ZXIub24oXCJjbG9zZVwiLCAoKSA9PiB7XG4gICAgICAgICAgICBpZih0aGlzLmdoY2lEZWJ1ZyAhPSBudWxsKVxuICAgICAgICAgICAgICAgIHRoaXMuZ2hjaURlYnVnLnN0b3AoKTtcbiAgICAgICAgfSlcblxuICAgICAgICB0aGlzLmdoY2lEZWJ1Zy5zZXRFeGNlcHRpb25CcmVha0xldmVsKGF0b20uY29uZmlnLmdldChcImhhc2tlbGwtZGVidWcuYnJlYWtPbkV4Y2VwdGlvblwiKSk7XG5cbiAgICAgICAgdGhpcy5kZWJ1Z1ZpZXcuZGlzYWJsZUFsbERlYnVnQnV0dG9ucygpO1xuXG4gICAgICAgIHZhciBmaWxlVG9EZWJ1ZyA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKS5nZXRQYXRoKClcbiAgICAgICAgdGhpcy5naGNpRGVidWcubG9hZE1vZHVsZShmaWxlVG9EZWJ1Zyk7XG5cbiAgICAgICAgYnJlYWtwb2ludHMuZm9yRWFjaChvYiA9PiB7XG4gICAgICAgICAgICBpZihvYi5maWxlID09IGZpbGVUb0RlYnVnKVxuICAgICAgICAgICAgICAgIHRoaXMuZ2hjaURlYnVnLmFkZEJyZWFrcG9pbnQob2IubGluZS50b1N0cmluZygpKTtcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICB0aGlzLmdoY2lEZWJ1Zy5hZGRCcmVha3BvaW50KG9iKSAvL1RPRE86IG1ha2UgdGhpcyB3b3JrIHByb3Blcmx5XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuZ2hjaURlYnVnLnN0YXJ0RGVidWcoYXRvbS5jb25maWcuZ2V0KFwiaGFza2VsbC1kZWJ1Zy5mdW5jdGlvblRvRGVidWdcIikpO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKGJyZWFrcG9pbnRzOiBCcmVha3BvaW50W10sIHByaXZhdGUgaWRlQ2FiYWxCdWlsZGVyQ29tbWFuZD86IHN0cmluZyl7XG4gICAgICAgIHRoaXMubGF1bmNoR0hDSURlYnVnQW5kQ29uc29sZShicmVha3BvaW50cyk7XG4gICAgICAgIHRoaXMuZGlzcGxheUdVSSgpO1xuICAgICAgICB0aGlzLmRpc3Bvc2FibGVzLmFkZChhdG9tLmNvbmZpZy5vbkRpZENoYW5nZShcImhhc2tlbGwtZGVidWcuYnJlYWtPbkV4Y2VwdGlvblwiLCAoe25ld1ZhbHVlfSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5naGNpRGVidWcuc2V0RXhjZXB0aW9uQnJlYWtMZXZlbCg8RXhjZXB0aW9uQnJlYWtMZXZlbHM+IG5ld1ZhbHVlKTtcbiAgICAgICAgfSkpO1xuICAgIH1cblxuICAgIC8qKiBGb3IgdGhlIHRvb2x0aXAgb3ZlcnJpZGUqL1xuICAgIGFzeW5jIHJlc29sdmVFeHByZXNzaW9uKGV4cHJlc3Npb246IHN0cmluZyl7XG4gICAgICAgIHJldHVybiB0aGlzLmdoY2lEZWJ1Zy5yZXNvbHZlRXhwcmVzc2lvbihleHByZXNzaW9uKTtcbiAgICB9XG5cbiAgICBiYWNrKCl7XG4gICAgICAgIGlmKHRoaXMuaGlzdG9yeVN0YXRlLnNldEN1cnJlbnRQb3NpdGlvbih0aGlzLmhpc3RvcnlTdGF0ZS5nZXRDdXJyZW50UG9zaXRpb24oKSArIDEpKVxuICAgICAgICAgICAgdGhpcy5naGNpRGVidWcuYmFjaygpO1xuICAgIH1cblxuICAgIGZvcndhcmQoKXtcbiAgICAgICAgaWYodGhpcy5oaXN0b3J5U3RhdGUuc2V0Q3VycmVudFBvc2l0aW9uKHRoaXMuaGlzdG9yeVN0YXRlLmdldEN1cnJlbnRQb3NpdGlvbigpIC0gMSkpXG4gICAgICAgICAgICB0aGlzLmdoY2lEZWJ1Zy5mb3J3YXJkKCk7XG4gICAgfVxuXG4gICAgY29udGludWUoKXtcbiAgICAgICAgdGhpcy5naGNpRGVidWcuY29udGludWUoKTtcbiAgICB9XG5cbiAgICBzdGVwKCl7XG4gICAgICAgIHRoaXMuZ2hjaURlYnVnLnN0ZXAoKTtcbiAgICB9XG5cbiAgICBzdG9wKCl7XG4gICAgICAgIHRoaXMuZ2hjaURlYnVnLnN0b3AoKTsgLy8gdGhpcyB3aWxsIHRyaWdnZXIgZGVidWctZmluaXNoZWQgZXZlbnRcbiAgICB9XG5cbiAgICBwcml2YXRlIHN0YXRpYyBnZXRXb3JraW5nRm9sZGVyKClcbiAgICB7XG4gICAgICAgIGNvbnN0IGZpbGVUb0RlYnVnID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpLmdldFBhdGgoKTtcbiAgICAgICAgcmV0dXJuIHBhdGguZGlybmFtZShmaWxlVG9EZWJ1Zyk7XG4gICAgfVxufVxuXG5leHBvcnQgPSBEZWJ1Z2dlcjtcbiJdfQ==