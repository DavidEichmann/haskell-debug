"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
const atomAPI = require("atom");
const _GHCIDebug = require("./GHCIDebug");
const DebugView = require("./views/DebugView");
const CurrentVariablesView = require("./views/CurrentVariablesView");
const HistoryState = require("./HistoryState");
const LineHighlighter = require("./LineHighlighter");
const TerminalReporter = require("./TerminalReporter");
var GHCIDebug = _GHCIDebug.GHCIDebug;
const path = require("path");
class Debugger {
    constructor(breakpoints, ideCabalBuilderCommand) {
        this.ideCabalBuilderCommand = ideCabalBuilderCommand;
        this.lineHighlighter = new LineHighlighter();
        this.ghciDebug = new GHCIDebug(this.getGhciCommand(), this.getGhciArgs(), Debugger.getWorkingFolder());
        this.debugView = new DebugView();
        this.historyState = new HistoryState();
        this.currentVariablesView = new CurrentVariablesView();
        this.terminalReporter = new TerminalReporter();
        this.disposables = new atomAPI.CompositeDisposable();
        this.debuggerEnabled = false;
        this.executingCommandFromConsole = false;
        this.launchGHCIDebugAndConsole(breakpoints);
        this.displayGUI();
        this.disposables.add(atom.config.onDidChange("haskell-debug.breakOnException", ({ newValue }) => {
            this.ghciDebug.setExceptionBreakLevel(newValue);
        }));
    }
    getGhciCommand() {
        if (atom.config.get("haskell-debug.useIdeHaskellCabalBuilder")) {
            switch (this.ideCabalBuilderCommand) {
                case "cabal":
                    return "cabal";
                case "stack":
                    return "stack";
                default:
                    return atom.config.get("haskell-debug.GHCICommand");
            }
        }
        return atom.config.get("haskell-debug.GHCICommand");
    }
    getGhciArgs() {
        const args = [];
        const ghciArgs = atom.config.get("haskell-debug.GHCIArguments");
        if (atom.config.get("haskell-debug.useIdeHaskellCabalBuilder")) {
            switch (this.ideCabalBuilderCommand) {
                case "cabal":
                    args.push("repl");
                    break;
                case "stack":
                    args.push("ghci");
                    break;
            }
        }
        if (ghciArgs.length > 0
            && (this.ideCabalBuilderCommand == "cabal"
                || this.ideCabalBuilderCommand == "stack")) {
            return args.concat(`--ghc-options="${atom.config.get("haskell-debug.GHCIArguments")}"`);
        }
        else {
            return args.concat(atom.config.get("haskell-debug.GHCIArguments").split(" "));
        }
    }
    destroy() {
        this.lineHighlighter.destroy();
        if (this.ghciDebug)
            this.ghciDebug.destroy();
        this.debugView.destroy();
        this.debugPanel.destroy();
        this.currentVariablesPanel.destroy();
        this.currentVariablesView.destroy();
        this.terminalReporter.destroy();
        this.disposables.dispose();
    }
    hidePanels() {
        this.debugPanel.hide();
        this.currentVariablesPanel.hide();
    }
    showPanels() {
        this.debugPanel.show();
        this.currentVariablesPanel.show();
    }
    displayGUI() {
        this.debugView = new DebugView();
        this.debugPanel = atom.workspace.addTopPanel({
            item: this.debugView.element
        });
        this.debugView.emitter.on("step", () => this.step());
        this.debugView.emitter.on("back", () => this.back());
        this.debugView.emitter.on("forward", () => this.forward());
        this.debugView.emitter.on("continue", () => this.continue());
        this.debugView.emitter.on("stop", () => this.stop());
        this.currentVariablesView = new CurrentVariablesView();
        this.currentVariablesPanel = atom.workspace.addTopPanel({
            item: this.currentVariablesView.element
        });
    }
    updateHistoryLengthAndEnableButtons(historyLength) {
        if (historyLength !== undefined) {
            this.historyState.setMaxPosition(historyLength);
        }
        this.debugView.enableAllDebugButtons();
        this.debugView.buttons.back.isEnabled = this.historyState.backEnabled;
        this.debugView.buttons.forward.isEnabled = this.historyState.forwardEnabled;
        this.debuggerEnabled = true;
    }
    launchGHCIDebugAndConsole(breakpoints) {
        this.ghciDebug.emitter.on("line-changed", (info) => {
            this.lineHighlighter.hightlightLine(info);
            this.updateHistoryLengthAndEnableButtons(info.historyLength);
            this.currentVariablesView.update(info.localBindings, false);
        });
        this.ghciDebug.emitter.on("paused-on-exception", (info) => {
            this.lineHighlighter.destroy();
            this.updateHistoryLengthAndEnableButtons(info.historyLength);
            this.currentVariablesView.update(info.localBindings, true);
        });
        this.ghciDebug.emitter.on("debug-finished", () => {
            this.ghciDebug = null;
            this.destroy();
        });
        this.ghciDebug.emitter.on("command-issued", (command) => {
            if (!this.executingCommandFromConsole)
                this.terminalReporter.displayCommand(command);
            this.debuggerEnabled = false;
            setTimeout(() => {
                if (!this.debuggerEnabled)
                    this.debugView.disableAllDebugButtons();
            }, 100);
        });
        this.ghciDebug.emitter.on("console-output", (output) => {
            this.terminalReporter.write(output);
        });
        this.ghciDebug.emitter.on("error-completed", (errorText) => {
            if (!this.executingCommandFromConsole)
                atom.notifications.addError("GHCI Error", {
                    detail: errorText,
                    dismissable: true
                });
        });
        this.ghciDebug.emitter.on("error", (errorText) => {
            this.terminalReporter.write(errorText);
        });
        this.ghciDebug.addedAllListeners();
        this.terminalReporter.emitter.on("command", (command) => __awaiter(this, void 0, void 0, function* () {
            this.executingCommandFromConsole = true;
            yield this.ghciDebug.run(command, true, true);
            this.executingCommandFromConsole = false;
        }));
        this.terminalReporter.emitter.on("close", () => {
            if (this.ghciDebug != null)
                this.ghciDebug.stop();
        });
        this.ghciDebug.setExceptionBreakLevel(atom.config.get("haskell-debug.breakOnException"));
        this.debugView.disableAllDebugButtons();
        var fileToDebug = atom.workspace.getActiveTextEditor().getPath();
        this.ghciDebug.loadModule(fileToDebug);
        breakpoints.forEach(ob => {
            if (ob.file == fileToDebug)
                this.ghciDebug.addBreakpoint(ob.line.toString());
            else
                this.ghciDebug.addBreakpoint(ob);
        });
        this.ghciDebug.startDebug(atom.config.get("haskell-debug.functionToDebug"));
    }
    resolveExpression(expression) {
        return __awaiter(this, void 0, void 0, function* () {
            return this.ghciDebug.resolveExpression(expression);
        });
    }
    back() {
        if (this.historyState.setCurrentPosition(this.historyState.getCurrentPosition() + 1))
            this.ghciDebug.back();
    }
    forward() {
        if (this.historyState.setCurrentPosition(this.historyState.getCurrentPosition() - 1))
            this.ghciDebug.forward();
    }
    continue() {
        this.ghciDebug.continue();
    }
    step() {
        this.ghciDebug.step();
    }
    stop() {
        this.ghciDebug.stop();
    }
    static getWorkingFolder() {
        const fileToDebug = atom.workspace.getActiveTextEditor().getPath();
        return path.dirname(fileToDebug);
    }
}
module.exports = Debugger;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGVidWdnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvbGliL0RlYnVnZ2VyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBLGdDQUFpQztBQUNqQywwQ0FBMkM7QUFDM0MsK0NBQWdEO0FBQ2hELHFFQUFzRTtBQUV0RSwrQ0FBZ0Q7QUFDaEQscURBQXNEO0FBQ3RELHVEQUF3RDtBQUN4RCxJQUFPLFNBQVMsR0FBRyxVQUFVLENBQUMsU0FBUyxDQUFDO0FBR3hDLDZCQUE4QjtBQUU5QjtJQW1MSSxZQUFZLFdBQXlCLEVBQVUsc0JBQStCO1FBQS9CLDJCQUFzQixHQUF0QixzQkFBc0IsQ0FBUztRQWxMdEUsb0JBQWUsR0FBRyxJQUFJLGVBQWUsRUFBRSxDQUFDO1FBQ3hDLGNBQVMsR0FBRyxJQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLEVBQUUsSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUFFLFFBQVEsQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDLENBQUM7UUFDbEcsY0FBUyxHQUFHLElBQUksU0FBUyxFQUFFLENBQUM7UUFDNUIsaUJBQVksR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBRWxDLHlCQUFvQixHQUFHLElBQUksb0JBQW9CLEVBQUUsQ0FBQztRQUVsRCxxQkFBZ0IsR0FBRyxJQUFJLGdCQUFnQixFQUFFLENBQUM7UUFDMUMsZ0JBQVcsR0FBRyxJQUFJLE9BQU8sQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1FBaUZoRCxvQkFBZSxHQUFHLEtBQUssQ0FBQztRQWF4QixnQ0FBMkIsR0FBRyxLQUFLLENBQUM7UUE2RXhDLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUM1QyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDbEIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsZ0NBQWdDLEVBQUUsQ0FBQyxFQUFD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QUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO0lBQzFCLENBQUM7SUFFTyxNQUFNLENBQUMsZ0JBQWdCO1FBRTNCLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUNuRSxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztJQUNyQyxDQUFDO0NBQ0o7QUFFRCxpQkFBUyxRQUFRLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXRvbUFQSSA9IHJlcXVpcmUoXCJhdG9tXCIpO1xuaW1wb3J0IF9HSENJRGVidWcgPSByZXF1aXJlKFwiLi9HSENJRGVidWdcIik7XG5pbXBvcnQgRGVidWdWaWV3ID0gcmVxdWlyZShcIi4vdmlld3MvRGVidWdWaWV3XCIpO1xuaW1wb3J0IEN1cnJlbnRWYXJpYWJsZXNWaWV3ID0gcmVxdWlyZShcIi4vdmlld3MvQ3VycmVudFZhcmlhYmxlc1ZpZXdcIik7XG5pbXBvcnQgQnJlYWtwb2ludFVJID0gcmVxdWlyZShcIi4vQnJlYWtwb2ludFVJXCIpO1xuaW1wb3J0IEhpc3RvcnlTdGF0ZSA9IHJlcXVpcmUoXCIuL0hpc3RvcnlTdGF0ZVwiKTtcbmltcG9ydCBMaW5lSGlnaGxpZ2h0ZXIgPSByZXF1aXJlKFwiLi9MaW5lSGlnaGxpZ2h0ZXJcIik7XG5pbXBvcnQgVGVybWluYWxSZXBvcnRlciA9IHJlcXVpcmUoXCIuL1Rlcm1pbmFsUmVwb3J0ZXJcIik7XG5pbXBvcnQgR0hDSURlYnVnID0gX0dIQ0lEZWJ1Zy5HSENJRGVidWc7XG5pbXBvcnQgQnJlYWtJbmZvID0gX0dIQ0lEZWJ1Zy5CcmVha0luZm87XG5pbXBvcnQgRXhjZXB0aW9uSW5mbyA9IF9HSENJRGVidWcuRXhjZXB0aW9uSW5mbztcbmltcG9ydCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XG5cbmNsYXNzIERlYnVnZ2Vye1xuICAgIHByaXZhdGUgbGluZUhpZ2hsaWdodGVyID0gbmV3IExpbmVIaWdobGlnaHRlcigpO1xuICAgIHByaXZhdGUgZ2hjaURlYnVnID0gbmV3IEdIQ0lEZWJ1Zyh0aGlzLmdldEdoY2lDb21tYW5kKCksIHRoaXMuZ2V0R2hjaUFyZ3MoKSwgRGVidWdnZXIuZ2V0V29ya2luZ0ZvbGRlcigpKTtcbiAgICBwcml2YXRlIGRlYnVnVmlldyA9IG5ldyBEZWJ1Z1ZpZXcoKTtcbiAgICBwcml2YXRlIGhpc3RvcnlTdGF0ZSA9IG5ldyBIaXN0b3J5U3RhdGUoKTtcbiAgICBwcml2YXRlIGRlYnVnUGFuZWw6IEF0b21Db3JlLlBhbmVsO1xuICAgIHByaXZhdGUgY3VycmVudFZhcmlhYmxlc1ZpZXcgPSBuZXcgQ3VycmVudFZhcmlhYmxlc1ZpZXcoKTtcbiAgICBwcml2YXRlIGN1cnJlbnRWYXJpYWJsZXNQYW5lbDogQXRvbUNvcmUuUGFuZWw7XG4gICAgcHJpdmF0ZSB0ZXJtaW5hbFJlcG9ydGVyID0gbmV3IFRlcm1pbmFsUmVwb3J0ZXIoKTtcbiAgICBwcml2YXRlIGRpc3Bvc2FibGVzID0gbmV3IGF0b21BUEkuQ29tcG9zaXRlRGlzcG9zYWJsZSgpO1xuXG4gICAgcHJpdmF0ZSBnZXRHaGNpQ29tbWFuZCgpe1xuICAgICAgICBpZihhdG9tLmNvbmZpZy5nZXQoXCJoYXNrZWxsLWRlYnVnLnVzZUlkZUhhc2tlbGxDYWJhbEJ1aWxkZXJcIikpe1xuICAgICAgICAgICAgc3dpdGNoKHRoaXMuaWRlQ2FiYWxCdWlsZGVyQ29tbWFuZCl7XG4gICAgICAgICAgICAgICAgY2FzZSBcImNhYmFsXCI6XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBcImNhYmFsXCI7XG4gICAgICAgICAgICAgICAgY2FzZSBcInN0YWNrXCI6XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBcInN0YWNrXCI7XG4gICAgICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGF0b20uY29uZmlnLmdldChcImhhc2tlbGwtZGVidWcuR0hDSUNvbW1hbmRcIilcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYXRvbS5jb25maWcuZ2V0KFwiaGFza2VsbC1kZWJ1Zy5HSENJQ29tbWFuZFwiKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldEdoY2lBcmdzKCl7XG4gICAgICAgIGNvbnN0IGFyZ3MgPSBbXTtcbiAgICAgICAgY29uc3QgZ2hjaUFyZ3MgPSBhdG9tLmNvbmZpZy5nZXQoXCJoYXNrZWxsLWRlYnVnLkdIQ0lBcmd1bWVudHNcIik7XG5cbiAgICAgICAgaWYoYXRvbS5jb25maWcuZ2V0KFwiaGFza2VsbC1kZWJ1Zy51c2VJZGVIYXNrZWxsQ2FiYWxCdWlsZGVyXCIpKXtcbiAgICAgICAgICAgIHN3aXRjaCh0aGlzLmlkZUNhYmFsQnVpbGRlckNvbW1hbmQpe1xuICAgICAgICAgICAgICAgIGNhc2UgXCJjYWJhbFwiOlxuICAgICAgICAgICAgICAgICAgICBhcmdzLnB1c2goXCJyZXBsXCIpO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlIFwic3RhY2tcIjpcbiAgICAgICAgICAgICAgICAgICAgYXJncy5wdXNoKFwiZ2hjaVwiKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgXG4gICAgICAgIGlmKGdoY2lBcmdzLmxlbmd0aCA+IDBcbiAgICAgICAgICAgICYmICh0aGlzLmlkZUNhYmFsQnVpbGRlckNvbW1hbmQgPT0gXCJjYWJhbFwiXG4gICAgICAgICAgICB8fCAgdGhpcy5pZGVDYWJhbEJ1aWxkZXJDb21tYW5kID09IFwic3RhY2tcIikpe1xuICAgICAgICAgICAgcmV0dXJuIGFyZ3MuY29uY2F0KGAtLWdoYy1vcHRpb25zPVwiJHthdG9tLmNvbmZpZy5nZXQoXCJoYXNrZWxsLWRlYnVnLkdIQ0lBcmd1bWVudHNcIil9XCJgKVxuICAgICAgICB9XG4gICAgICAgIGVsc2V7XG4gICAgICAgICAgICByZXR1cm4gYXJncy5jb25jYXQoYXRvbS5jb25maWcuZ2V0KFwiaGFza2VsbC1kZWJ1Zy5HSENJQXJndW1lbnRzXCIpLnNwbGl0KFwiIFwiKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGRlc3Ryb3koKXtcbiAgICAgICAgdGhpcy5saW5lSGlnaGxpZ2h0ZXIuZGVzdHJveSgpO1xuICAgICAgICBpZih0aGlzLmdoY2lEZWJ1ZylcbiAgICAgICAgICAgIHRoaXMuZ2hjaURlYnVnLmRlc3Ryb3koKTtcbiAgICAgICAgdGhpcy5kZWJ1Z1ZpZXcuZGVzdHJveSgpO1xuICAgICAgICB0aGlzLmRlYnVnUGFuZWwuZGVzdHJveSgpO1xuICAgICAgICB0aGlzLmN1cnJlbnRWYXJpYWJsZXNQYW5lbC5kZXN0cm95KCk7XG4gICAgICAgIHRoaXMuY3VycmVudFZhcmlhYmxlc1ZpZXcuZGVzdHJveSgpO1xuICAgICAgICB0aGlzLnRlcm1pbmFsUmVwb3J0ZXIuZGVzdHJveSgpO1xuICAgICAgICB0aGlzLmRpc3Bvc2FibGVzLmRpc3Bvc2UoKTtcbiAgICB9XG5cbiAgICBoaWRlUGFuZWxzKCl7XG4gICAgICAgIHRoaXMuZGVidWdQYW5lbC5oaWRlKCk7XG4gICAgICAgIHRoaXMuY3VycmVudFZhcmlhYmxlc1BhbmVsLmhpZGUoKTtcbiAgICB9XG5cbiAgICBzaG93UGFuZWxzKCl7XG4gICAgICAgIHRoaXMuZGVidWdQYW5lbC5zaG93KCk7XG4gICAgICAgIHRoaXMuY3VycmVudFZhcmlhYmxlc1BhbmVsLnNob3coKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGRpc3BsYXlHVUkoKXtcbiAgICAgICAgdGhpcy5kZWJ1Z1ZpZXcgPSBuZXcgRGVidWdWaWV3KCk7XG4gICAgICAgIHRoaXMuZGVidWdQYW5lbCA9IGF0b20ud29ya3NwYWNlLmFkZFRvcFBhbmVsKHtcbiAgICAgICAgICAgIGl0ZW06IHRoaXMuZGVidWdWaWV3LmVsZW1lbnRcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5kZWJ1Z1ZpZXcuZW1pdHRlci5vbihcInN0ZXBcIiwgKCkgPT4gdGhpcy5zdGVwKCkpO1xuICAgICAgICB0aGlzLmRlYnVnVmlldy5lbWl0dGVyLm9uKFwiYmFja1wiLCAoKSA9PiB0aGlzLmJhY2soKSk7XG4gICAgICAgIHRoaXMuZGVidWdWaWV3LmVtaXR0ZXIub24oXCJmb3J3YXJkXCIsICgpID0+IHRoaXMuZm9yd2FyZCgpKTtcbiAgICAgICAgdGhpcy5kZWJ1Z1ZpZXcuZW1pdHRlci5vbihcImNvbnRpbnVlXCIsICgpID0+IHRoaXMuY29udGludWUoKSk7XG4gICAgICAgIHRoaXMuZGVidWdWaWV3LmVtaXR0ZXIub24oXCJzdG9wXCIsICgpID0+IHRoaXMuc3RvcCgpKTtcblxuICAgICAgICB0aGlzLmN1cnJlbnRWYXJpYWJsZXNWaWV3ID0gbmV3IEN1cnJlbnRWYXJpYWJsZXNWaWV3KCk7XG4gICAgICAgIHRoaXMuY3VycmVudFZhcmlhYmxlc1BhbmVsID0gYXRvbS53b3Jrc3BhY2UuYWRkVG9wUGFuZWwoe1xuICAgICAgICAgICAgaXRlbTogdGhpcy5jdXJyZW50VmFyaWFibGVzVmlldy5lbGVtZW50XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIHByaXZhdGUgZGVidWdnZXJFbmFibGVkID0gZmFsc2U7XG5cbiAgICBwcml2YXRlIHVwZGF0ZUhpc3RvcnlMZW5ndGhBbmRFbmFibGVCdXR0b25zKGhpc3RvcnlMZW5ndGg6IG51bWJlcil7XG4gICAgICAgIGlmKGhpc3RvcnlMZW5ndGggIT09IHVuZGVmaW5lZCl7XG4gICAgICAgICAgICB0aGlzLmhpc3RvcnlTdGF0ZS5zZXRNYXhQb3NpdGlvbihoaXN0b3J5TGVuZ3RoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuZGVidWdWaWV3LmVuYWJsZUFsbERlYnVnQnV0dG9ucygpO1xuICAgICAgICB0aGlzLmRlYnVnVmlldy5idXR0b25zLmJhY2suaXNFbmFibGVkID0gdGhpcy5oaXN0b3J5U3RhdGUuYmFja0VuYWJsZWQ7XG4gICAgICAgIHRoaXMuZGVidWdWaWV3LmJ1dHRvbnMuZm9yd2FyZC5pc0VuYWJsZWQgPSB0aGlzLmhpc3RvcnlTdGF0ZS5mb3J3YXJkRW5hYmxlZDtcbiAgICAgICAgdGhpcy5kZWJ1Z2dlckVuYWJsZWQgPSB0cnVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgZXhlY3V0aW5nQ29tbWFuZEZyb21Db25zb2xlID0gZmFsc2U7XG4gICAgcHJpdmF0ZSBsYXVuY2hHSENJRGVidWdBbmRDb25zb2xlKGJyZWFrcG9pbnRzOiBCcmVha3BvaW50W10pe1xuICAgICAgICB0aGlzLmdoY2lEZWJ1Zy5lbWl0dGVyLm9uKFwibGluZS1jaGFuZ2VkXCIsIChpbmZvOiBCcmVha0luZm8pID0+IHtcbiAgICAgICAgICAgIHRoaXMubGluZUhpZ2hsaWdodGVyLmhpZ2h0bGlnaHRMaW5lKGluZm8pO1xuICAgICAgICAgICAgdGhpcy51cGRhdGVIaXN0b3J5TGVuZ3RoQW5kRW5hYmxlQnV0dG9ucyhpbmZvLmhpc3RvcnlMZW5ndGgpO1xuICAgICAgICAgICAgdGhpcy5jdXJyZW50VmFyaWFibGVzVmlldy51cGRhdGUoaW5mby5sb2NhbEJpbmRpbmdzLCBmYWxzZSk7XG4gICAgICAgIH0pXG5cbiAgICAgICAgdGhpcy5naGNpRGVidWcuZW1pdHRlci5vbihcInBhdXNlZC1vbi1leGNlcHRpb25cIiwgKGluZm86IEV4Y2VwdGlvbkluZm8pID0+IHtcbiAgICAgICAgICAgIHRoaXMubGluZUhpZ2hsaWdodGVyLmRlc3Ryb3koKTtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlSGlzdG9yeUxlbmd0aEFuZEVuYWJsZUJ1dHRvbnMoaW5mby5oaXN0b3J5TGVuZ3RoKTtcbiAgICAgICAgICAgIHRoaXMuY3VycmVudFZhcmlhYmxlc1ZpZXcudXBkYXRlKGluZm8ubG9jYWxCaW5kaW5ncywgdHJ1ZSk7XG4gICAgICAgIH0pXG5cbiAgICAgICAgdGhpcy5naGNpRGVidWcuZW1pdHRlci5vbihcImRlYnVnLWZpbmlzaGVkXCIsICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZ2hjaURlYnVnID0gbnVsbDtcbiAgICAgICAgICAgIHRoaXMuZGVzdHJveSgpXG4gICAgICAgIH0pXG5cbiAgICAgICAgdGhpcy5naGNpRGVidWcuZW1pdHRlci5vbihcImNvbW1hbmQtaXNzdWVkXCIsIChjb21tYW5kKSA9PiB7XG4gICAgICAgICAgICBpZighdGhpcy5leGVjdXRpbmdDb21tYW5kRnJvbUNvbnNvbGUpXG4gICAgICAgICAgICAgICAgdGhpcy50ZXJtaW5hbFJlcG9ydGVyLmRpc3BsYXlDb21tYW5kKGNvbW1hbmQpO1xuXG4gICAgICAgICAgICB0aGlzLmRlYnVnZ2VyRW5hYmxlZCA9IGZhbHNlO1xuICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYoIXRoaXMuZGVidWdnZXJFbmFibGVkKVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmRlYnVnVmlldy5kaXNhYmxlQWxsRGVidWdCdXR0b25zKCk7XG4gICAgICAgICAgICB9LCAxMDApO1xuICAgICAgICB9KVxuXG4gICAgICAgIHRoaXMuZ2hjaURlYnVnLmVtaXR0ZXIub24oXCJjb25zb2xlLW91dHB1dFwiLCAob3V0cHV0KSA9PiB7XG4gICAgICAgICAgICB0aGlzLnRlcm1pbmFsUmVwb3J0ZXIud3JpdGUob3V0cHV0KTtcbiAgICAgICAgfSlcblxuICAgICAgICB0aGlzLmdoY2lEZWJ1Zy5lbWl0dGVyLm9uKFwiZXJyb3ItY29tcGxldGVkXCIsIChlcnJvclRleHQpID0+IHtcbiAgICAgICAgICAgIGlmKCF0aGlzLmV4ZWN1dGluZ0NvbW1hbmRGcm9tQ29uc29sZSlcbiAgICAgICAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoXCJHSENJIEVycm9yXCIsIHtcbiAgICAgICAgICAgICAgICAgICAgZGV0YWlsOiBlcnJvclRleHQsXG4gICAgICAgICAgICAgICAgICAgIGRpc21pc3NhYmxlOiB0cnVlXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgfSlcblxuICAgICAgICB0aGlzLmdoY2lEZWJ1Zy5lbWl0dGVyLm9uKFwiZXJyb3JcIiwgKGVycm9yVGV4dCkgPT4ge1xuICAgICAgICAgICAgdGhpcy50ZXJtaW5hbFJlcG9ydGVyLndyaXRlKGVycm9yVGV4dCk7XG4gICAgICAgIH0pXG5cbiAgICAgICAgdGhpcy5naGNpRGVidWcuYWRkZWRBbGxMaXN0ZW5lcnMoKTtcblxuICAgICAgICB0aGlzLnRlcm1pbmFsUmVwb3J0ZXIuZW1pdHRlci5vbihcImNvbW1hbmRcIiwgYXN5bmMgY29tbWFuZCA9PiB7XG4gICAgICAgICAgICB0aGlzLmV4ZWN1dGluZ0NvbW1hbmRGcm9tQ29uc29sZSA9IHRydWU7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmdoY2lEZWJ1Zy5ydW4oY29tbWFuZCwgdHJ1ZSwgdHJ1ZSk7XG4gICAgICAgICAgICB0aGlzLmV4ZWN1dGluZ0NvbW1hbmRGcm9tQ29uc29sZSA9IGZhbHNlO1xuICAgICAgICB9KVxuXG4gICAgICAgIHRoaXMudGVybWluYWxSZXBvcnRlci5lbWl0dGVyLm9uKFwiY2xvc2VcIiwgKCkgPT4ge1xuICAgICAgICAgICAgaWYodGhpcy5naGNpRGVidWcgIT0gbnVsbClcbiAgICAgICAgICAgICAgICB0aGlzLmdoY2lEZWJ1Zy5zdG9wKCk7XG4gICAgICAgIH0pXG5cbiAgICAgICAgdGhpcy5naGNpRGVidWcuc2V0RXhjZXB0aW9uQnJlYWtMZXZlbChhdG9tLmNvbmZpZy5nZXQoXCJoYXNrZWxsLWRlYnVnLmJyZWFrT25FeGNlcHRpb25cIikpO1xuXG4gICAgICAgIHRoaXMuZGVidWdWaWV3LmRpc2FibGVBbGxEZWJ1Z0J1dHRvbnMoKTtcblxuICAgICAgICB2YXIgZmlsZVRvRGVidWcgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCkuZ2V0UGF0aCgpXG4gICAgICAgIHRoaXMuZ2hjaURlYnVnLmxvYWRNb2R1bGUoZmlsZVRvRGVidWcpO1xuXG4gICAgICAgIGJyZWFrcG9pbnRzLmZvckVhY2gob2IgPT4ge1xuICAgICAgICAgICAgaWYob2IuZmlsZSA9PSBmaWxlVG9EZWJ1ZylcbiAgICAgICAgICAgICAgICB0aGlzLmdoY2lEZWJ1Zy5hZGRCcmVha3BvaW50KG9iLmxpbmUudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgdGhpcy5naGNpRGVidWcuYWRkQnJlYWtwb2ludChvYikgLy9UT0RPOiBtYWtlIHRoaXMgd29yayBwcm9wZXJseVxuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmdoY2lEZWJ1Zy5zdGFydERlYnVnKGF0b20uY29uZmlnLmdldChcImhhc2tlbGwtZGVidWcuZnVuY3Rpb25Ub0RlYnVnXCIpKTtcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3RvcihicmVha3BvaW50czogQnJlYWtwb2ludFtdLCBwcml2YXRlIGlkZUNhYmFsQnVpbGRlckNvbW1hbmQ/OiBzdHJpbmcpe1xuICAgICAgICB0aGlzLmxhdW5jaEdIQ0lEZWJ1Z0FuZENvbnNvbGUoYnJlYWtwb2ludHMpO1xuICAgICAgICB0aGlzLmRpc3BsYXlHVUkoKTtcbiAgICAgICAgdGhpcy5kaXNwb3NhYmxlcy5hZGQoYXRvbS5jb25maWcub25EaWRDaGFuZ2UoXCJoYXNrZWxsLWRlYnVnLmJyZWFrT25FeGNlcHRpb25cIiwgKHtuZXdWYWx1ZX0pID0+IHtcbiAgICAgICAgICAgIHRoaXMuZ2hjaURlYnVnLnNldEV4Y2VwdGlvbkJyZWFrTGV2ZWwoPEV4Y2VwdGlvbkJyZWFrTGV2ZWxzPiBuZXdWYWx1ZSk7XG4gICAgICAgIH0pKTtcbiAgICB9XG5cbiAgICAvKiogRm9yIHRoZSB0b29sdGlwIG92ZXJyaWRlKi9cbiAgICBhc3luYyByZXNvbHZlRXhwcmVzc2lvbihleHByZXNzaW9uOiBzdHJpbmcpe1xuICAgICAgICByZXR1cm4gdGhpcy5naGNpRGVidWcucmVzb2x2ZUV4cHJlc3Npb24oZXhwcmVzc2lvbik7XG4gICAgfVxuXG4gICAgYmFjaygpe1xuICAgICAgICBpZih0aGlzLmhpc3RvcnlTdGF0ZS5zZXRDdXJyZW50UG9zaXRpb24odGhpcy5oaXN0b3J5U3RhdGUuZ2V0Q3VycmVudFBvc2l0aW9uKCkgKyAxKSlcbiAgICAgICAgICAgIHRoaXMuZ2hjaURlYnVnLmJhY2soKTtcbiAgICB9XG5cbiAgICBmb3J3YXJkKCl7XG4gICAgICAgIGlmKHRoaXMuaGlzdG9yeVN0YXRlLnNldEN1cnJlbnRQb3NpdGlvbih0aGlzLmhpc3RvcnlTdGF0ZS5nZXRDdXJyZW50UG9zaXRpb24oKSAtIDEpKVxuICAgICAgICAgICAgdGhpcy5naGNpRGVidWcuZm9yd2FyZCgpO1xuICAgIH1cblxuICAgIGNvbnRpbnVlKCl7XG4gICAgICAgIHRoaXMuZ2hjaURlYnVnLmNvbnRpbnVlKCk7XG4gICAgfVxuXG4gICAgc3RlcCgpe1xuICAgICAgICB0aGlzLmdoY2lEZWJ1Zy5zdGVwKCk7XG4gICAgfVxuXG4gICAgc3RvcCgpe1xuICAgICAgICB0aGlzLmdoY2lEZWJ1Zy5zdG9wKCk7IC8vIHRoaXMgd2lsbCB0cmlnZ2VyIGRlYnVnLWZpbmlzaGVkIGV2ZW50XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBzdGF0aWMgZ2V0V29ya2luZ0ZvbGRlcigpXG4gICAge1xuICAgICAgICBjb25zdCBmaWxlVG9EZWJ1ZyA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKS5nZXRQYXRoKCk7XG4gICAgICAgIHJldHVybiBwYXRoLmRpcm5hbWUoZmlsZVRvRGVidWcpO1xuICAgIH1cbn1cblxuZXhwb3J0ID0gRGVidWdnZXI7XG4iXX0=